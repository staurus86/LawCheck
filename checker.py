#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""Класс проверки текста - УЛУЧШЕННАЯ ВЕРСИЯ С PYASPELLER"""

import re
from pathlib import Path
import sys
from functools import lru_cache

try:
    import pymorphy3
    MORPH_AVAILABLE = True
except:
    MORPH_AVAILABLE = False

try:
    from pyaspeller import YandexSpeller, Word
    PYASPELLER_AVAILABLE = True
except:
    PYASPELLER_AVAILABLE = False

class RussianLanguageChecker:
    def __init__(self):
        self.normative_words = set()
        self.foreign_allowed = set()
        self.nenormative_words = set()
        
        # Кэш для pyaspeller
        self.speller_cache = {}
        
        print("\n" + "="*60)
        print("INIT RussianLanguageChecker")
        print("="*60)
        
        # Морфология
        if MORPH_AVAILABLE:
            try:
                self.morph = pymorphy3.MorphAnalyzer()
                print("[OK] pymorphy3 loaded")
            except Exception as e:
                self.morph = None
                print(f"[WARN] pymorphy3 error: {e}")
        else:
            self.morph = None
            print("[WARN] pymorphy3 not available")
        
        # Pyaspeller - Yandex Speller
        if PYASPELLER_AVAILABLE:
            try:
                self.speller = YandexSpeller()
                print("[OK] pyaspeller (YandexSpeller) loaded")
            except Exception as e:
                self.speller = None
                print(f"[WARN] pyaspeller error: {e}")
        else:
            self.speller = None
            print("[WARN] pyaspeller not available")
        
        self.add_common_words()
        self.load_dictionaries()
        
        print("\n" + "="*60)
        print("TOTAL LOADED:")
        print("="*60)
        print(f"[OK] Normative: {len(self.normative_words):,}")
        print(f"[OK] Foreign: {len(self.foreign_allowed):,}")
        print(f"[OK] Nenormative: {len(self.nenormative_words):,}")
        print("="*60 + "\n")
    
    def add_common_words(self):
        """Базовые слова - расширенный набор частых русских слов"""
        common = {
            # Предлоги и союзы
            'и', 'в', 'на', 'по', 'от', 'до', 'из', 'к', 'с', 'у', 'о', 'об', 'при',
            'но', 'да', 'не', 'за', 'во', 'а', 'под', 'про', 'для', 'без', 'через',
            'над', 'перед', 'между', 'около', 'после', 'вместо', 'вдоль', 'возле',
            'внутри', 'вне', 'исключая', 'включая', 'согласно', 'благодаря',
            'вопреки', 'навстречу', 'наперекор', 'несмотря', 'со', 'подо',
            
            # Местоимения
            'я', 'ты', 'он', 'она', 'оно', 'мы', 'вы', 'они',
            'меня', 'тебя', 'его', 'её', 'нас', 'вас', 'их',
            'мне', 'тебе', 'ему', 'ей', 'нам', 'вам', 'им',
            'мной', 'тобой', 'им', 'ей', 'нами', 'вами', 'ими',
            'мой', 'твой', 'свой', 'наш', 'ваш', 'их',
            'моя', 'твоя', 'своя', 'наша', 'ваша',
            'моё', 'твоё', 'своё', 'наше', 'ваше',
            'мои', 'твои', 'свои', 'наши', 'ваши',
            'это', 'этот', 'эта', 'эти', 'тот', 'та', 'то', 'те',
            'который', 'которые', 'которая', 'которое', 'которого', 'которым',
            'весь', 'вся', 'все', 'всё', 'всем', 'всеми',
            'себя', 'себе', 'собой', 'сам', 'сама', 'сами', 'само',
            'кто', 'что', 'какой', 'какая', 'какие', 'чей', 'чья',
            'никто', 'ничто', 'некого', 'нечего',
            
            # Частицы и наречия
            'же', 'бы', 'ли', 'пусть', 'пускай', 'таки', 'ведь', 'даже', 'только',
            'так', 'также', 'очень', 'более', 'менее', 'совсем', 'почти',
            'там', 'тут', 'здесь', 'где', 'куда', 'откуда', 'везде', 'никуда',
            'сейчас', 'тогда', 'всегда', 'никогда', 'иногда', 'часто', 'редко',
            'быстро', 'медленно', 'хорошо', 'плохо', 'легко', 'трудно', 'просто',
            'вместе', 'отдельно', 'особо', 'специально', 'примерно', 'точно',
            'именно', 'особенно', 'например', 'вообще', 'вероятно', 'видимо',
            
            # Числительные
            'один', 'одна', 'одно', 'два', 'две', 'три', 'четыре', 'пять',
            'шесть', 'семь', 'восемь', 'девять', 'десять', 'ноль',
            'первый', 'второй', 'третий', 'четвёртый', 'пятый',
            'одиннадцать', 'двенадцать', 'двадцать', 'тридцать', 'сорок',
            'пятьдесят', 'сто', 'тысяча', 'миллион', 'миллиард',
            'полтора', 'оба', 'обе', 'сколько', 'столько', 'несколько',
            
            # Прилагательные частые
            'большой', 'большая', 'большое', 'большие',
            'маленький', 'маленькая', 'маленькое',
            'хороший', 'хорошая', 'хорошее', 'хорошие',
            'плохой', 'плохая', 'плохое',
            'новый', 'новая', 'новое', 'новые',
            'старый', 'старая', 'старое',
            'молодой', 'молодая', 'молодое',
            'красивый', 'красивая', 'красивое',
            'высокий', 'высокая', 'высокое',
            'низкий', 'низкая', 'низкое',
            'длинный', 'длинная', 'длинное',
            'короткий', 'короткая', 'короткое',
            'широкий', 'широкая', 'широкое',
            'узкий', 'узкая', 'узкое',
            'тяжёлый', 'тяжёлая', 'лёгкий', 'лёгкая',
            'сильный', 'сильная', 'слабый', 'слабая',
            'быстрый', 'быстрая', 'медленный', 'медленная',
            'горячий', 'горячая', 'холодный', 'холодная',
            'весёлый', 'весёлая', 'грустный', 'грустная',
            'умный', 'умная', 'глупый', 'глупая',
            'смелый', 'смелая', 'трусливый',
            'честный', 'честная', 'бесчестный',
            'добрый', 'добрая', 'злой', 'злая',
            'чистый', 'чистая', 'грязный', 'грязная',
            'богатый', 'богатая', 'бедный', 'бедная',
            'дорогой', 'дорогая', 'дешёвый', 'дешёвая',
            'важный', 'важная', 'нужный', 'нужная',
            'полезный', 'полезная', 'вредный', 'вредная',
            'разный', 'разная', 'разное', 'разные',
            'всеобщий', 'общий', 'частный', 'частная',
            'главный', 'главная', 'основной', 'основная',
            'простой', 'простая', 'сложный', 'сложная',
            'ясный', 'ясная', 'понятный', 'понятная',
            'интересный', 'интересная', 'скучный', 'скучная',
            'приятный', 'приятная', 'неприятный',
            'удобный', 'удобная', 'неудобный',
            'возможный', 'возможная', 'невозможный',
            'верный', 'верная', 'неверный', 'неверная',
            'полный', 'полная', 'пустой', 'пустая',
            'открытый', 'открытая', 'закрытый', 'закрытая',
            'свободный', 'свободная', 'занятый', 'занятая',
            'готовый', 'готовая', 'готовые',
            'правильный', 'правильная', 'неправильный',
            'современный', 'современная', 'старомодный',
            'необходимый', 'необходимая', 'нужный',
            'технический', 'техническая', 'технологический',
            'профессиональный', 'профессиональная',
            'практический', 'практическая', 'теоретический',
            'реальный', 'реальная', 'нереальный', 'фактический',
            'прекрасный', 'прекрасная', 'отличный', 'отличная',
            'замечательный', 'замечательная', 'превосходный',
            'серьёзный', 'серьёзная', 'весёлый', 'весёлая',
            'спокойный', 'спокойная', 'нервный', 'нервная',
            'активный', 'активная', 'пассивный', 'пассивная',
            'позитивный', 'позитивная', 'негативный', 'негативная',
            'конкретный', 'конкретная', 'абстрактный',
            'прямой', 'прямая', 'косвенный',
            'первичный', 'первичная', 'вторичный', 'вторичная',
            'внутренний', 'внутренняя', 'внешний', 'внешняя',
            'местный', 'местная', 'общий', 'местное',
            'федеральный', 'федеральная', 'региональный',
            'национальный', 'национальная', 'международный',
            'социальный', 'социальная', 'экономический', 'экономическая',
            'политический', 'политическая', 'культурный', 'культурная',
            'исторический', 'историческая', 'географический',
            'биологический', 'химический', 'физический',
            'математический', 'логический', 'психологический',
            'медицинский', 'медицинская', 'юридический', 'юридическая',
            'коммерческий', 'коммерческая', 'финансовый', 'финансовая',
            
            # Глаголы частые
            'быть', 'есть', 'являться', 'оказываться', 'становиться',
            'иметь', 'обладать', 'владеть', 'пользоваться', 'использовать',
            'делать', 'сделать', 'выполнять', 'выполнить', 'осуществлять',
            'говорить', 'сказать', 'рассказывать', 'рассказать', 'объяснять',
            'знать', 'понимать', 'узнавать', 'узнать', 'учить', 'учиться',
            'думать', 'думать', 'считать', 'полагать', 'верить', 'надеяться',
            'видеть', 'смотреть', 'увидеть', 'замечать', 'наблюдать',
            'слышать', 'слушать', 'услышать',
            'читать', 'писать', 'переписывать', 'записывать',
            'брать', 'взять', 'давать', 'дать', 'получать', 'получить',
            'ходить', 'идти', 'приходить', 'прийти', 'уходить', 'уйти',
            'ездить', 'ехать', 'приезжать', 'приехать', 'уезжать', 'уехать',
            'бежать', 'бегать', 'лететь', 'летать', 'плавать', 'плыть',
            'стоять', 'сидеть', 'лежать', 'висеть', 'валяться',
            'жить', 'проживать', 'существовать', 'находиться', 'располагаться',
            'работать', 'трудиться', 'заниматься', 'устраиваться',
            'учиться', 'учить', 'обучаться', 'преподавать',
            'отдыхать', 'спать', 'лёг', 'легла', 'засыпать', 'просыпаться',
            'есть', 'кушать', 'пить', 'поить', 'кормить', 'питаться',
            'покупать', 'купить', 'продавать', 'продать', 'торговать',
            'платить', 'заплатить', 'тратить', 'потратить', 'копить',
            'искать', 'искал', 'искала', 'находить', 'найти',
            'терять', 'потерять', 'теряться', 'терял', 'теряла',
            'открывать', 'открыть', 'закрывать', 'закрыть',
            'начинать', 'начать', 'кончать', 'кончить', 'заканчивать',
            'продолжать', 'продолжить', 'останавливаться', 'остановиться',
            'входить', 'войти', 'выходить', 'выйти', 'приходить', 'прийти',
            'подходить', 'подойти', 'уходить', 'уйти', 'проходить', 'пройти',
            'возвращаться', 'вернуться', 'приходить', 'прийти',
            'спрашивать', 'спросить', 'отвечать', 'ответить',
            'звонить', 'позвонить', 'звать', 'позвать', 'кричать', 'крикнуть',
            'молчать', 'промолчать', 'говорить', 'сказать', 'повторять',
            'понимать', 'понять', 'осознавать', 'осознать',
            'забывать', 'забыть', 'помнить', 'вспоминать', 'вспомнить',
            'узнавать', 'узнать', 'узнавал', 'узнавала',
            'помогать', 'помочь', 'помог', 'помогла',
            'мешать', 'помешать', 'мешал', 'мешала',
            'любить', 'полюбить', 'нравиться', 'понравиться',
            'хотеть', 'захотеть', 'хотел', 'хотела', 'желать',
            'мочь', 'смочь', 'мог', 'могла', 'могли',
            'должен', 'должна', 'должны', 'должно',
            'нужно', 'нужен', 'нужна', 'нужны',
            'можно', 'нельзя', 'надо', 'необходимо',
            'давать', 'дать', 'дарить', 'подарить', 'отдавать', 'отдать',
            'брать', 'взять', 'забирать', 'забрать', 'отбирать', 'отобрать',
            'держать', 'подержать', 'держал', 'держала',
            'ловить', 'поймать', 'ловил', 'ловила',
            'бросать', 'бросить', 'кидать', 'кинуть',
            'падать', 'упасть', 'валиться', 'рушиться',
            'подниматься', 'подняться', 'поднимать', 'поднять',
            'опускаться', 'опуститься', 'опускать', 'опустить',
            'расти', 'вырасти', 'вырастать', 'уменьшаться', 'увеличиваться',
            'меняться', 'измениться', 'изменяться', 'превращаться', 'стать',
            'создавать', 'создать', 'творить', 'сотворить', 'делать', 'сделать',
            'строить', 'построить', 'строил', 'строила',
            'ломать', 'сломать', 'ломал', 'ломала',
            'чинить', 'починить', 'ремонтировать', 'отремонтировать',
            'чистить', 'почистить', 'мыть', 'помыть', 'стирать', 'постирать',
            'готовить', 'приготовить', 'варить', 'сварить', 'жарить', 'зажарить',
            'резать', 'порезать', 'резал', 'резала', 'крошить', 'покрошить',
            'кусать', 'укусить', 'кусал', 'кусала',
            'ударять', 'ударить', 'ударил', 'ударила', 'бить', 'побить',
            'трогать', 'тронуть', 'трогал', 'трогала', 'щупать', 'пощупать',
            'чувствовать', 'почувствовать', 'ощущать', 'почувствовал',
            'видеть', 'увидеть', 'видал', 'видела', 'зреть', 'узреть',
            'смотреть', 'посмотреть', 'смотрел', 'смотрела', 'глядеть', 'поглядеть',
            'следить', 'проследить', 'следил', 'следила', 'наблюдать', 'понаблюдать',
            'ждать', 'подождать', 'ждал', 'ждала', 'ожидать', 'предполагать',
            'надеяться', 'понадеяться', 'надеялся', 'надеялась',
            'бояться', 'побояться', 'боялся', 'боялась', 'страшиться',
            'радоваться', 'обрадоваться', 'радовался', 'радовалась',
            'грустить', 'погрустить', 'грустил', 'грустила', 'печалиться',
            'смеяться', 'рассмеяться', 'смеялся', 'смеялась', 'хохотать',
            'плакать', 'заплакать', 'плакал', 'плакала', 'рыдать',
            'улыбаться', 'улыбнуться', 'улыбался', 'улыбалась', 'сиять', 'сиял',
            'сердиться', 'рассердиться', 'сердился', 'сердилась', 'злиться', 'разозлиться',
            'удивляться', 'удивиться', 'удивлялся', 'удивлялась', 'изумляться',
            'волноваться', 'поволноваться', 'волновался', 'волновалась', 'беспокоиться',
            'успокаиваться', 'успокоиться', 'успокоил', 'успокоила',
            
            # Существительные частые
            'человек', 'человека', 'люди', 'людей', 'лицо', 'лица',
            'мужчина', 'мужчины', 'женщина', 'женщины', 'мальчик', 'мальчики',
            'девочка', 'девочки', 'ребёнок', 'ребёнка', 'дети', 'детей',
            'сын', 'сына', 'сыновья', 'дочь', 'дочери', 'дочка', 'родители',
            'мать', 'матери', 'мама', 'мамы', 'отец', 'отца', 'папа', 'папы',
            'брат', 'брата', 'братья', 'сестра', 'сестры', 'бабушка', 'дедушка',
            'семья', 'семьи', 'род', 'рода', 'родня', 'родственники',
            'друг', 'друга', 'друзья', 'подруга', 'подруги', 'товарищ', 'знакомый',
            'сосед', 'соседа', 'соседи', 'гость', 'гостя', 'гости',
            'хозяин', 'хозяина', 'хозяйка', 'господин', 'госпожа',
            'народ', 'народы', 'население', 'жители', 'граждане',
            'товарищ', 'коллега', 'коллеги', 'начальник', 'начальника', 'шеф', 'босс',
            'работник', 'работника', 'работники', 'сотрудник', 'сотрудники',
            'учитель', 'учителя', 'учительница', 'преподаватель', 'профессор',
            'врач', 'врача', 'доктор', 'медсестра', 'медбрат',
            'инженер', 'программист', 'менеджер', 'директор', 'бухгалтер',
            'юрист', 'адвокат', 'судья', 'полицейский', 'милиционер',
            'продавец', 'продавца', 'кассир', 'официант', 'официантка',
            'водитель', 'водителя', 'пилот', 'стюардесса', 'проводник',
            'дом', 'дома', 'квартира', 'квартиры', 'комната', 'комнаты',
            'кухня', 'кухни', 'ванная', 'туалет', 'прихожая', 'коридор',
            'окно', 'окна', 'дверь', 'двери', 'стена', 'стены', 'потолок', 'пол',
            'крыша', 'фундамент', 'лестница', 'балкон', 'лифт',
            'город', 'города', 'городок', 'посёлок', 'деревня', 'село',
            'страна', 'страны', 'государство', 'республика', 'область', 'край',
            'улица', 'улицы', 'проспект', 'проезд', 'переулок', 'площадь',
            'мост', 'мосты', 'туннель', 'дорога', 'дороги', 'трасса', 'шоссе',
            'машина', 'машины', 'автомобиль', 'автомобили', 'машинка',
            'автобус', 'троллейбус', 'трамвай', 'такси', 'метро',
            'поезд', 'поезда', 'вагон', 'вагоны', 'платформа', 'станция',
            'самолёт', 'самолёты', 'вертолёт', 'аэропорт', 'взлёт', 'посадка',
            'корабль', 'корабли', 'лодка', 'лодки', 'пароход', 'катер',
            'велосипед', 'велосипеды', 'мотоцикл', 'мопед', 'самокат',
            'время', 'времена', 'час', 'часы', 'минута', 'минуты', 'секунда',
            'день', 'дня', 'дни', 'неделя', 'недели', 'месяц', 'месяцы',
            'год', 'года', 'годы', 'век', 'века', 'время', 'эпоха', 'период',
            'утро', 'утра', 'день', 'днём', 'вечер', 'вечера', 'ночь', 'ночи',
            'сегодня', 'вчера', 'завтра', 'послезавтра', 'неделю', 'назад',
            'понедельник', 'вторник', 'среда', 'четверг', 'пятница', 'суббота', 'воскресенье',
            'январь', 'февраль', 'март', 'апрель', 'май', 'июнь',
            'июль', 'август', 'сентябрь', 'октябрь', 'ноябрь', 'декабрь',
            'зима', 'весна', 'лето', 'осень',
            'вещь', 'вещи', 'предмет', 'предметы', 'объект', 'объекты',
            'продукт', 'продукты', 'товар', 'товары', 'вещество', 'вещества',
            'еда', 'пища', 'кухня', 'блюдо', 'блюда', 'кушанье',
            'хлеб', 'масло', 'молоко', 'мясо', 'рыба', 'курица', 'яйцо',
            'сыр', 'творог', 'сметана', 'йогурт', 'кефир',
            'фрукт', 'фрукты', 'яблоко', 'яблоки', 'груша', 'груши',
            'апельсин', 'мандарин', 'лимон', 'банан', 'виноград',
            'овощ', 'овощи', 'картошка', 'морковь', 'лук', 'чеснок',
            'огурец', 'помидор', 'перец', 'капуста', 'свёкла',
            'суп', 'супы', 'борщ', 'щи', 'каша', 'каши', 'макароны',
            'вода', 'воды', 'сок', 'соки', 'чай', 'кофе', 'какао',
            'сахар', 'соль', 'перец', 'мука', 'рис', 'гречка',
            'одежда', 'одежды', 'платье', 'платья', 'костюм', 'костюмы',
            'рубашка', 'рубашки', 'брюки', 'джинсы', 'юбка', 'юбки',
            'куртка', 'куртки', 'пальто', 'плащ', 'шуба', 'шубы',
            'обувь', 'туфли', 'ботинки', 'сапоги', 'кроссовки', 'тапочки',
            'шапка', 'шапки', 'шарф', 'перчатки', 'варежки',
            'цвет', 'цвета', 'красный', 'синий', 'зелёный', 'жёлтый',
            'белый', 'чёрный', 'серый', 'коричневый', 'оранжевый', 'фиолетовый',
            'форма', 'формы', 'размер', 'размеры', 'вес', 'длина', 'ширина',
            'высота', 'глубина', 'объём', 'площадь', 'масса',
            'часть', 'части', 'доля', 'кусок', 'куски', 'половина', 'четверть',
            'группа', 'группы', 'команда', 'команды', 'отряд', 'бригада',
            'система', 'системы', 'сеть', 'сети', 'структура', 'структуры',
            'процесс', 'процессы', 'этап', 'этапы', 'стадия', 'стадии',
            'проблема', 'проблемы', 'вопрос', 'вопросы', 'задача', 'задачи',
            'тема', 'темы', 'предмет', 'предметы', 'область', 'области', 'сфера',
            'цель', 'цели', 'задача', 'задачи', 'план', 'планы', 'программа',
            'результат', 'результаты', 'итог', 'итоги', 'вывод', 'выводы',
            'причина', 'причины', 'следствие', 'следствия', 'цель', 'цели',
            'начало', 'начала', 'конец', 'концы', 'середина', 'середины',
            'суть', 'сути', 'содержание', 'смысл', 'значение', 'значения',
            'идея', 'идеи', 'мысль', 'мысли', 'понятие', 'понятия',
            'способ', 'способы', 'метод', 'методы', 'приём', 'приёмы',
            'средство', 'средства', 'инструмент', 'инструменты', 'орудие',
            'условие', 'условия', 'требование', 'требования', 'правило', 'правила',
            'закон', 'законы', 'норма', 'нормы', 'принцип', 'принципы',
            'мера', 'меры', 'степень', 'уровень', 'уровни', 'стандарт',
            'качество', 'качества', 'свойство', 'свойства', 'признак', 'признаки',
            'вид', 'виды', 'тип', 'типы', 'форма', 'формы', 'класс', 'классы',
            'разряд', 'категория', 'категории', 'классификация', 'сорт',
            'пример', 'примеры', 'образец', 'образцы', 'экземпляр', 'экземпляры',
            'аналог', 'аналоги', 'вариант', 'варианты', 'альтернатива', 'выбор',
            'возможность', 'возможности', 'шанс', 'шансы', 'попытка', 'попытки',
            'успех', 'удача', 'победа', 'провал', 'неудача', 'поражение',
            'счастье', 'радость', 'веселье', 'восторг', 'удовольствие',
            'горе', 'печаль', 'страдание', 'тоска', 'разочарование',
            'страх', 'ужас', 'испуг', 'тревога', 'волнение', 'беспокойство',
            'гнев', 'ярость', 'злость', 'раздражение', 'недовольство',
            'любовь', 'любви', 'нежность', 'привязанность', 'симпатия',
            'ненависть', 'отвращение', 'враждебность', 'зависть', 'ревность',
            'дружба', 'друзья', 'приятель', 'приятели', 'знакомый', 'знакомые',
            'уважение', 'почёт', 'авторитет', 'влияние', 'власть', 'сила',
            'слабость', 'бессилие', 'зависимость', 'подчинение', 'подчинённость',
            'свобода', 'свободы', 'независимость', 'самостоятельность', 'автономия',
            'ответственность', 'долг', 'обязанность', 'обязательство',
            'честь', 'достоинство', 'совесть', 'честность', 'правдивость',
            'добро', 'зло', 'справедливость', 'несправедливость',
            'красота', 'уродство', 'эстетика', 'гармония', 'пропорция',
            'истина', 'ложь', 'обман', 'ошибка', 'заблуждение', 'иллюзия',
            'реальность', 'действительность', 'факт', 'событие', 'явление',
            'природа', 'природы', 'мир', 'миры', 'вселенная', 'космос',
            'земля', 'земли', 'земля', 'почва', 'грунт', 'территория',
            'небо', 'небеса', 'солнце', 'луна', 'звезда', 'звёзды',
            'воздух', 'атмосфера', 'ветер', 'дождь', 'снег', 'туман',
            'огонь', 'пламя', 'вода', 'льд', 'пар', 'дым',
            'камень', 'камни', 'песок', 'грязь', 'глина', 'пыль',
            'дерево', 'деревья', 'лес', 'леса', 'куст', 'кусты', 'трава',
            'цветок', 'цветы', 'растение', 'растения', 'животное', 'животные',
            'птица', 'птицы', 'рыба', 'рыбы', 'насекомое', 'насекомые',
            'человечество', 'общество', 'цивилизация', 'культура', 'история',
            'язык', 'языки', 'речь', 'слово', 'слова', 'текст', 'тексты',
            'письмо', 'письма', 'письменность', 'литература', 'искусство',
            'музыка', 'песня', 'песни', 'танец', 'танцы', 'живопись',
            'наука', 'науки', 'знание', 'знания', 'образование', 'учёба',
            'техника', 'технологии', 'промышленность', 'производство',
            'торговля', 'коммерция', 'бизнес', 'предпринимательство',
            'экономика', 'финансы', 'деньги', 'валюта', 'банк', 'банки',
            'рынок', 'рынки', 'магазин', 'магазины', 'фирма', 'фирмы',
            'компания', 'компании', 'организация', 'организации', 'учреждение',
            'государство', 'власть', 'политика', 'правительство', 'администрация',
            'закон', 'законы', 'право', 'суд', 'судебный', 'арест', 'тюрьма',
            'армия', 'войска', 'воин', 'воины', 'солдат', 'солдаты',
            'война', 'войны', 'битва', 'сражение', 'мир', 'перемирие',
            'здоровье', 'болезнь', 'болезни', 'лекарство', 'лекарства',
            'спорт', 'спорты', 'игра', 'игры', 'матч', 'соревнование',
            'отдых', 'каникулы', 'праздник', 'праздники', 'юбилей',
            'подарок', 'подарки', 'сюрприз', 'сюрпризы', 'празднование',
            
            # Имена собственные (распространённые)
            'андрей', 'андрея', 'александр', 'александра', 'сергей', 'сергея',
            'дмитрий', 'дмитрия', 'николай', 'николая', 'владимир', 'владимира',
            'иван', 'ивана', 'пётр', 'петра', 'михаил', 'михаила',
            'алексей', 'алексея', 'максим', 'максима', 'артём', 'артёма',
            'даниил', 'даниила', 'кирилл', 'кирилла', 'матвей', 'матвея',
            'елена', 'елены', 'ольга', 'ольги', 'мария', 'марии',
            'анна', 'анны', 'надежда', 'надежды', 'людмила', 'людмилы',
            'татьяна', 'татьяны', 'светлана', 'светланы', 'ирина', 'ирины',
            'екатерина', 'екатерины', 'виктория', 'виктории', 'алина', 'алины',
            'москва', 'москвы', 'питер', 'петербург', 'спб',
            'россия', 'россии', 'русь', 'руси', 'советский', 'ссср',
            'европа', 'европы', 'азия', 'америка', 'африка', 'австралия',
            'англия', 'франция', 'германия', 'италия', 'испания', 'польша',
            'украина', 'белоруссия', 'казахстан', 'грузия', 'армения',
            'китай', 'япония', 'корея', 'индия', 'турция', 'египет',
            'сша', 'сша', 'канада', 'мексика', 'бразилия', 'аргентина',
            
            # Сайты и бренды
            'авито', 'яндекс', 'гугл', 'google', 'youtube', 'ютуб',
            'вконтакте', 'vk', 'facebook', 'фейсбук', 'instagram', 'инстаграм',
            'twitter', 'твиттер', 'telegram', 'телеграм', 'whatsapp', 'ватсап',
            'twitch', 'твич', 'tiktok', 'тикток', 'ozon', 'озон',
            'wildberries', 'вайлдберриз', 'aliexpress', 'алиэкспресс',
            'сбер', 'сбербанк', 'тинькофф', 'альфа', 'втб', 'газпром',
            'роснефть', 'лукойл', 'мтс', 'мегафон', 'билайн', 'теле2',
            
            # Профессии и должности
            'менеджер', 'менеджера', 'менеджеры', 'руководитель', 'руководители',
            'специалист', 'специалисты', 'эксперт', 'эксперты', 'консультант',
            'аналитик', 'разработчик', 'программист', 'тестировщик', 'дизайнер',
            'маркетолог', 'smm', 'seo', 'копирайтер', 'редактор', 'журналист',
            'бухгалтер', 'экономист', 'финансист', 'аудитор', 'юрист', 'адвокат',
            'менеджер', 'продавец', 'кассир', 'оператор', 'администратор',
            'охранник', 'водитель', 'курьер', 'уборщица', 'горничная',
            
            # Технические термины (русские)
            'компьютер', 'компьютера', 'ноутбук', 'ноутбука', 'планшет', 'телефон',
            'смартфон', 'айфон', 'iphone', 'android', 'андроид', 'windows',
            'виндовс', 'linux', 'линукс', 'программа', 'приложение', 'приложения',
            'сайт', 'сайты', 'сервис', 'сервисы', 'платформа', 'платформы',
            'база', 'базы', 'данные', 'информация', 'контент', 'контенты',
            'файл', 'файлы', 'документ', 'документы', 'папка', 'папки',
            'пароль', 'логин', 'аккаунт', 'профиль', 'страница', 'страницы',
            'ссылка', 'ссылки', 'кнопка', 'кнопки', 'форма', 'формы',
            'загрузка', 'скачивание', 'установка', 'настройка', 'обновление',
            'версия', 'версии', 'лицензия', 'лицензии', 'подписка', 'подписки',
            'тариф', 'тарифы', 'бесплатный', 'платный', 'триал', 'демо',
            'сервер', 'сервера', 'хостинг', 'домен', 'домены', 'ip', 'айпи',
            'браузер', 'браузеры', 'chrome', 'король', 'firefox', 'файрфокс',
            'edge', 'эдж', 'safari', 'сафари', 'opera', 'опера',
            'поиск', 'поиски', 'результат', 'результаты', 'фильтр', 'фильтры',
            'сортировка', 'сортировки', 'категория', 'категории', 'раздел',
            
            # Маркетинг и бизнес
            'бизнес', 'бизнеса', 'бизнесы', 'компания', 'компании', 'фирма',
            'стартап', 'стартапы', 'проект', 'проекты', 'заказ', 'заказы',
            'клиент', 'клиенты', 'заказчик', 'заказчики', 'партнёр', 'партнёры',
            'инвестор', 'инвесторы', 'спонсор', 'спонсоры', 'рекламодатель',
            'продажа', 'продажи', 'покупка', 'покупки', 'закупка', 'закупки',
            'предложение', 'предложения', 'спрос', 'цена', 'цены', 'стоимость',
            'скидка', 'скидки', 'распродажа', 'акция', 'акции', 'бонус',
            'кэшбэк', 'кэшбек', 'кешбэк', 'баллы', 'промокод', 'купон',
            'доставка', 'доставки', 'самовывоз', 'курьер', 'курьеры',
            'оплата', 'оплаты', 'наличные', 'карта', 'карты', 'перевод',
            'счёт', 'счета', 'чек', 'чеки', 'накладная', 'счет-фактура',
            'договор', 'договоры', 'соглашение', 'соглашения', 'контракт',
            'гарантия', 'гарантии', 'возврат', 'обмен', 'отмена', 'отмены',
            'отзыв', 'отзывы', 'рейтинг', 'рейтинги', 'оценка', 'оценки',
            'популярный', 'популярная', 'рекомендуемый', 'хит', 'хиты',
            'новинка', 'новинки', 'топ', 'тренд', 'тренды', 'хайп',
            
            # Глаголы-бизнес
            'заказывать', 'заказать', 'покупать', 'купить', 'продавать', 'продать',
            'приобретать', 'приобрести', 'оплачивать', 'оплатить', 'расплачиваться',
            'регистрироваться', 'зарегистрироваться', 'оформлять', 'оформить',
            'подписываться', 'подписаться', 'оформлять', 'оформить', 'заполнять',
            'отправлять', 'отправить', 'получать', 'получить', 'ждать', 'дожидаться',
            'возвращать', 'вернуть', 'обменивать', 'обменять', 'отменять', 'отменить',
            'бронировать', 'забронировать', 'резервировать', 'зарезервировать',
            'проверять', 'проверить', 'подтверждать', 'подтвердить', 'уточнять',
            'звонить', 'позвонить', 'писать', 'написать', 'спрашивать', 'спросить',
            'жаловаться', 'пожаловаться', 'благодарить', 'поблагодарить', 'рекомендовать',
            'советовать', 'посоветовать', 'предлагать', 'предложить', 'соглашаться',
            'отказываться', 'отказаться', 'выбирать', 'выбрать', 'сравнивать',
            'искать', 'находить', 'найти', 'терять', 'потерять', 'хранить',
            'сохранять', 'сохранить', 'загружать', 'загрузить', 'скачивать',
            'обновлять', 'обновить', 'менять', 'поменять', 'настраивать',
            'включать', 'включить', 'выключать', 'выключить', 'открывать',
            'закрывать', 'закрыть', 'добавлять', 'добавить', 'удалять', 'удалить',
            'создавать', 'создать', 'составлять', 'составить', 'готовить',
            'оформлять', 'оформить', 'выполнять', 'выполнить', 'завершать',
            'начинать', 'начать', 'продолжать', 'продолжить', 'останавливаться',
            'работать', 'трудиться', 'заниматься', 'зарабатывать', 'заработать',
            'тратить', 'потратить', 'экономить', 'сэкономить', 'копить', 'накопить',
            'инвестировать', 'вкладывать', 'вложить', 'снимать', 'снять',
            'переводить', 'перевести', 'платить', 'заплатить', 'оплачивать',
            'возвращать', 'вернуть', 'отдавать', 'отдать', 'занимать', 'занять',
            'давать', 'дать', 'брать', 'взять', 'одалживать', 'одолжить',
        }
        self.normative_words.update(common)
        
        # Generate all word forms via pymorphy3
        if self.morph:
            forms_added = 0
            unique_forms = set()
            
            for word in list(common):
                try:
                    parsed = self.morph.parse(word)
                    if parsed:
                        for p in parsed[:2]:  # Top 2 parses
                            # Get lexeme (all word forms)
                            try:
                                lexeme = p.lexeme
                                for lex in lexeme:
                                    form = lex.word.lower()
                                    if form not in unique_forms:
                                        unique_forms.add(form)
                                        self.normative_words.add(form)
                                        forms_added += 1
                            except:
                                # Fallback: just add the word form
                                form = p.word.lower()
                                if form not in unique_forms:
                                    unique_forms.add(form)
                                    self.normative_words.add(form)
                                    forms_added += 1
                except Exception as e:
                    pass
            
            print(f"[OK] Base dictionary: {len(common)} words + {forms_added} generated forms")
            print(f"  Total unique forms: {len(self.normative_words):,}")
        else:
            print(f"[OK] Base dictionary: {len(common)} words")
    
    def load_dictionaries(self):
        """Load dictionaries from files"""
        # All possible paths
        possible_paths = [
            Path('dictionaries'),
            Path('.') / 'dictionaries',
            Path(__file__).parent / 'dictionaries',
            Path.cwd() / 'dictionaries',
        ]
        
        dict_path = None
        for path in possible_paths:
            if path.exists() and path.is_dir():
                dict_path = path
                print(f"[OK] Dictionaries folder found: {path.absolute()}")
                break
        
        if not dict_path:
            print("[OK][OK] DICTIONARIES FOLDER NOT FOUND!")
            print("   Check that dictionaries/ folder exists")
            print("   Current directory:", Path.cwd())
            return
        
        # Files to load
        files_to_load = {
            'orfograf_words.txt': 'normative_words',
            'orfoep_words.txt': 'normative_words',
            'foreign_words.txt': 'foreign_allowed',
            'Nenormativnye_slova.txt': 'nenormative_words'
        }
        
        loaded = 0
        for filename, target_attr in files_to_load.items():
            filepath = dict_path / filename
            
            if not filepath.exists():
                print(f"[OK][OK] File not found: {filename}")
                continue
            
            try:
                with open(filepath, 'r', encoding='utf-8', errors='ignore') as f:
                    words = set()
                    line_count = 0
                    for line in f:
                        line_count += 1
                        word = line.strip().lower()
                        if word and not word.startswith('#') and len(word) > 1:
                            words.add(word)
                    
                    if words:
                        getattr(self, target_attr).update(words)
                        print(f"[OK] {filename}: {len(words):,} words (lines: {line_count})")
                        loaded += 1
                    else:
                        print(f"[OK][OK] {filename}: empty file")
            
            except Exception as e:
                print(f"[OK] Error loading {filename}: {e}")
        
        print(f"\nFiles loaded: {loaded}/{len(files_to_load)}")
    
    def is_known_word(self, word):
        """Improved word check with pyaspeller and pymorphy3"""
        word_lower = word.lower()
        
        # Check in dictionaries
        if word_lower in self.normative_words or word_lower in self.foreign_allowed:
            return True
        
        # Check normal form in dictionaries
        if self.morph:
            try:
                normal_form = self.get_word_normal_form(word)
                if normal_form in self.normative_words:
                    return True
                # Also check if word forms of normal form exist
                parsed = self.morph.parse(normal_form)
                if parsed:
                    for p in parsed[:3]:  # Check top 3 parses
                        if p.normal_form in self.normative_words:
                            return True
            except:
                pass
        
        # Check via pyaspeller (Yandex Speller) - recognizes word forms!
        if self.speller and PYASPELLER_AVAILABLE:
            try:
                speller_result = self.check_with_speller(word)
                if speller_result:
                    # If speller says it's correct - it's a valid Russian word
                    if speller_result.get('correct', False):
                        return True
                    # If speller suggests variants - word might have typo
                    # but we consider the original form as "known" 
                    # if variants are similar (same root)
                    variants = speller_result.get('variants', [])
                    if variants:
                        # Check if any variant is in our dictionary
                        for variant in variants[:2]:
                            if variant.lower() in self.normative_words:
                                return True
            except:
                pass
        
        # Check via pymorphy3 with expanded logic
        if self.morph:
            try:
                parsed = self.morph.parse(word_lower)
                if parsed:
                    best_parse = parsed[0]
                    # Personal names
                    if 'Name' in best_parse.tag or 'Surn' in best_parse.tag or 'Patr' in best_parse.tag:
                        return True
                    # Geographic names
                    if 'Geox' in best_parse.tag:
                        return True
                    # Organizations
                    if 'Orgn' in best_parse.tag:
                        return True
                    # Has part of speech = real word
                    if best_parse.tag.POS:
                        # Check if normal form is known
                        if best_parse.normal_form in self.normative_words:
                            return True
                        # Check score - high confidence
                        if best_parse.score > 0.1:
                            return True
            except:
                pass
        
        # Abbreviations (all caps, up to 10 chars)
        if word.isupper() and len(word) <= 10:
            return True
            
        # Capitalized words (proper nouns)
        if word[0].isupper() and len(word) > 1:
            return True
        
        # Hyphenated words
        if '-' in word:
            parts = word_lower.split('-')
            known_parts = 0
            for part in parts:
                if len(part) > 1:
                    if part in self.normative_words or part in self.foreign_allowed:
                        known_parts += 1
                    elif self.morph:
                        try:
                            if self.get_word_normal_form(part) in self.normative_words:
                                known_parts += 1
                        except:
                            pass
            # If majority of parts are known
            if known_parts >= len(parts) / 2:
                return True
        
        return False
    
    def check_with_speller(self, word):
        """Check word using Yandex Speller with caching"""
        if not self.speller or not PYASPELLER_AVAILABLE:
            return None
        
        word_lower = word.lower()
        
        # Check cache
        if word_lower in self.speller_cache:
            return self.speller_cache[word_lower]
        
        try:
            # Use Word class for single word check
            check = Word(word_lower)
            result = {
                'correct': check.correct,
                'variants': check.variants if hasattr(check, 'variants') else [],
                'spellsafe': check.spellsafe if hasattr(check, 'spellsafe') else True
            }
            
            # Cache result
            self.speller_cache[word_lower] = result
            return result
            
        except Exception as e:
            # If error, cache negative result
            self.speller_cache[word_lower] = {'correct': False, 'variants': [], 'error': str(e)}
            return None
    
    def get_word_normal_form(self, word):
        """Get normal form of word using pymorphy3 with improved case handling"""
        if not self.morph or not MORPH_AVAILABLE:
            return word.lower()
        
        word_lower = word.lower()
        
        try:
            parsed = self.morph.parse(word_lower)
            if parsed:
                best = parsed[0]
                return best.normal_form
        except:
            pass
        
        return word_lower
    
    def is_nenormative(self, word):
        """Проверка ненормативности"""
        word_lower = word.lower()
        
        if word_lower in self.nenormative_words:
            return True
        
        if self.morph:
            try:
                parsed = self.morph.parse(word_lower)
                if parsed and parsed[0].normal_form in self.nenormative_words:
                    return True
            except:
                pass
        
        return False
    
    def check_text(self, text):
        """Проверка текста"""
        if not text or not text.strip():
            return {
                'latin_words': [],
                'unknown_cyrillic': [],
                'nenormative_words': [],
                'latin_count': 0,
                'unknown_count': 0,
                'nenormative_count': 0,
                'violations_count': 0,
                'law_compliant': True,
                'total_words': 0,
                'unique_words': 0
            }
        
        # Очистка
        text = re.sub(r'https?://[^\s]+', ' ', text)
        text = re.sub(r'\+?\d[\d\s\-\(\)]{7,}', ' ', text)
        
        all_words = re.findall(r'\b[а-яёА-ЯЁa-zA-Z][а-яёА-ЯЁa-zA-Z\-]*\b', text)
        
        latin_words = []
        unknown_cyrillic = []
        nenormative_found = []
        
        skip = {'и', 'в', 'на', 'по', 'от', 'до', 'из', 'к', 'с', 'у', 'о',
                'но', 'да', 'не', 'за', 'об', 'во', 'а', 'я'}
        
        for word in all_words:
            if len(word) == 1 or word.lower() in skip:
                continue
            
            if self.is_nenormative(word):
                nenormative_found.append(word)
                continue
            
            if re.search(r'[a-zA-Z]', word):
                latin_words.append(word)
                continue
            
            if not self.is_known_word(word):
                unknown_cyrillic.append(word)
        
        latin_words = sorted(list(set(latin_words)))
        unknown_cyrillic = sorted(list(set(unknown_cyrillic)))
        nenormative_found = sorted(list(set(nenormative_found)))
        
        return {
            'latin_words': latin_words,
            'unknown_cyrillic': unknown_cyrillic,
            'nenormative_words': nenormative_found,
            'latin_count': len(latin_words),
            'unknown_count': len(unknown_cyrillic),
            'nenormative_count': len(nenormative_found),
            'violations_count': len(latin_words) + len(unknown_cyrillic) + len(nenormative_found),
            'law_compliant': (len(latin_words) + len(unknown_cyrillic) + len(nenormative_found)) == 0,
            'total_words': len(all_words),
            'unique_words': len(set(all_words))
        }


# Test on run
if __name__ == "__main__":
    print("\n" + "="*60)
    print("TESTING RussianLanguageChecker")
    print("="*60)
    
    checker = RussianLanguageChecker()
    
    # Test with different word forms (cases)
    test_cases = [
        "Это тестовый текст для проверки. Hello world! Профессиональный подход.",
        "Мы работаем с документами разных видов",  # разных видов - different cases
        "Компания предлагает услуги клиентам",      # клиентам - dative case
        "Безопасность системы важна для нас",       # системы - genitive case
    ]
    
    for i, test_text in enumerate(test_cases, 1):
        print(f"\nTest {i}: {test_text[:50]}...")
        result = checker.check_text(test_text)
        print(f"  Violations: {result['violations_count']}")
        if result['unknown_cyrillic']:
            print(f"  Unknown: {result['unknown_cyrillic']}")
    
    print("\n" + "="*60)
    print("TEST COMPLETE")
    print("="*60 + "\n")
