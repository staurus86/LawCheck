#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""Класс проверки текста - ОПТИМИЗИРОВАННАЯ ВЕРСИЯ"""

import re
from pathlib import Path
import sys

try:
    import pymorphy3
    MORPH_AVAILABLE = True
except:
    MORPH_AVAILABLE = False

try:
    from pyaspeller import YandexSpeller
    PYASPELLER_AVAILABLE = True
except:
    PYASPELLER_AVAILABLE = False

_RE_URL = re.compile(r'https?://[^\s]+')
_RE_PHONE = re.compile(r'\+?\d[\d\s\-\(\)]{7,}')
_RE_LATIN = re.compile(r'[a-zA-Z]')
_RE_WORD = re.compile(r'\b[а-яёА-ЯЁa-zA-Z][а-яёА-ЯЁa-zA-Z\-]*\b')

class RussianLanguageChecker:
    __slots__ = ('normative_words', 'foreign_allowed', 'nenormative_words',
                 'speller_cache', 'forms_cache', 'all_forms', 'morph', 'speller',
                 '_word_prefixes', '_skip_words', 'abbreviations', '_normal_form_cache')

    def __init__(self):
        self.normative_words = set()
        self.foreign_allowed = set()
        self.nenormative_words = set()
        self.speller_cache = {}
        self.forms_cache = {}
        self.all_forms = set()
        self.abbreviations = {}
        self._normal_form_cache = {}  # Кэш для нормальных форм

        print("\n" + "="*60)
        print("INIT RussianLanguageChecker (OPTIMIZED)")
        print("="*60)

        if MORPH_AVAILABLE:
            try:
                self.morph = pymorphy3.MorphAnalyzer()
                print("[OK] pymorphy3 loaded")
            except Exception as e:
                self.morph = None
                print(f"[WARN] pymorphy3 error: {e}")
        else:
            self.morph = None
            print("[WARN] pymorphy3 not available")

        if PYASPELLER_AVAILABLE:
            try:
                self.speller = YandexSpeller()
                print("[OK] pyaspeller (YandexSpeller) loaded")
            except Exception as e:
                self.speller = None
                print(f"[WARN] pyaspeller error: {e}")
        else:
            self.speller = None
            print("[WARN] pyaspeller not available")

        self._word_prefixes = None
        self._skip_words = None

        self.add_common_words()
        self.load_dictionaries()

        print("\n" + "="*60)
        print("TOTAL LOADED:")
        print("="*60)
        print(f"[OK] Normative: {len(self.normative_words):,}")
        print(f"[OK] Foreign: {len(self.foreign_allowed):,}")
        print(f"[OK] Nenormative: {len(self.nenormative_words):,}")
        print(f"[OK] Abbreviations: {len(self.abbreviations):,}")
        print("="*60 + "\n")
    
    def _is_abbreviation(self, word):
        """Автоопределение аббревиатуры"""
        word_clean = re.sub(r'[^a-zA-Z0-9]', '', word)
        if len(word_clean) < 2 or len(word_clean) > 8:
            return False
        if not word_clean.isupper():
            return False
        if not word_clean.isalpha():
            return False
        return True
    
    def add_common_words(self):
        """Базовые слова - расширенный набор частых русских слов"""
        common = {
            # Предлоги и союзы
            'и', 'в', 'на', 'по', 'от', 'до', 'из', 'к', 'с', 'у', 'о', 'об', 'при',
            'но', 'да', 'не', 'за', 'во', 'а', 'под', 'про', 'для', 'без', 'через',
            'над', 'перед', 'между', 'около', 'после', 'вместо', 'вдоль', 'возле',
            'внутри', 'вне', 'исключая', 'включая', 'согласно', 'благодаря',
            'вопреки', 'навстречу', 'наперекор', 'несмотря', 'со', 'подо',
            
            # Местоимения
            'я', 'ты', 'он', 'она', 'оно', 'мы', 'вы', 'они',
            'меня', 'тебя', 'его', 'её', 'нас', 'вас', 'их',
            'мне', 'тебе', 'ему', 'ей', 'нам', 'вам', 'им',
            'мной', 'тобой', 'им', 'ей', 'нами', 'вами', 'ими',
            'мой', 'твой', 'свой', 'наш', 'ваш', 'их',
            'моя', 'твоя', 'своя', 'наша', 'ваша',
            'моё', 'твоё', 'своё', 'наше', 'ваше',
            'мои', 'твои', 'свои', 'наши', 'ваши',
            'это', 'этот', 'эта', 'эти', 'тот', 'та', 'то', 'те',
            'который', 'которые', 'которая', 'которое', 'которого', 'которым',
            'весь', 'вся', 'все', 'всё', 'всем', 'всеми',
            'себя', 'себе', 'собой', 'сам', 'сама', 'сами', 'само',
            'кто', 'что', 'какой', 'какая', 'какие', 'чей', 'чья',
            'никто', 'ничто', 'некого', 'нечего',
            
            # Частицы и наречия
            'же', 'бы', 'ли', 'пусть', 'пускай', 'таки', 'ведь', 'даже', 'только',
            'так', 'также', 'очень', 'более', 'менее', 'совсем', 'почти',
            'там', 'тут', 'здесь', 'где', 'куда', 'откуда', 'везде', 'никуда',
            'сейчас', 'тогда', 'всегда', 'никогда', 'иногда', 'часто', 'редко',
            'быстро', 'медленно', 'хорошо', 'плохо', 'легко', 'трудно', 'просто',
            'вместе', 'отдельно', 'особо', 'специально', 'примерно', 'точно',
            'именно', 'особенно', 'например', 'вообще', 'вероятно', 'видимо',
            
            # Числительные
            'один', 'одна', 'одно', 'два', 'две', 'три', 'четыре', 'пять',
            'шесть', 'семь', 'восемь', 'девять', 'десять', 'ноль',
            'первый', 'второй', 'третий', 'четвёртый', 'пятый',
            'одиннадцать', 'двенадцать', 'двадцать', 'тридцать', 'сорок',
            'пятьдесят', 'сто', 'тысяча', 'миллион', 'миллиард',
            'полтора', 'оба', 'обе', 'сколько', 'столько', 'несколько',
            
            # Прилагательные частые
            'большой', 'большая', 'большое', 'большие',
            'маленький', 'маленькая', 'маленькое',
            'хороший', 'хорошая', 'хорошее', 'хорошие',
            'плохой', 'плохая', 'плохое',
            'новый', 'новая', 'новое', 'новые',
            'старый', 'старая', 'старое',
            'молодой', 'молодая', 'молодое',
            'красивый', 'красивая', 'красивое',
            'высокий', 'высокая', 'высокое',
            'низкий', 'низкая', 'низкое',
            'длинный', 'длинная', 'длинное',
            'короткий', 'короткая', 'короткое',
            'широкий', 'широкая', 'широкое',
            'узкий', 'узкая', 'узкое',
            'тяжёлый', 'тяжёлая', 'лёгкий', 'лёгкая',
            'сильный', 'сильная', 'слабый', 'слабая',
            'быстрый', 'быстрая', 'медленный', 'медленная',
            'горячий', 'горячая', 'холодный', 'холодная',
            'весёлый', 'весёлая', 'грустный', 'грустная',
            'умный', 'умная', 'глупый', 'глупая',
            'смелый', 'смелая', 'трусливый',
            'честный', 'честная', 'бесчестный',
            'добрый', 'добрая', 'злой', 'злая',
            'чистый', 'чистая', 'грязный', 'грязная',
            'богатый', 'богатая', 'бедный', 'бедная',
            'дорогой', 'дорогая', 'дешёвый', 'дешёвая',
            'важный', 'важная', 'нужный', 'нужная',
            'полезный', 'полезная', 'вредный', 'вредная',
            'разный', 'разная', 'разное', 'разные',
            'всеобщий', 'общий', 'частный', 'частная',
            'главный', 'главная', 'основной', 'основная',
            'простой', 'простая', 'сложный', 'сложная',
            'ясный', 'ясная', 'понятный', 'понятная',
            'интересный', 'интересная', 'скучный', 'скучная',
            'приятный', 'приятная', 'неприятный',
            'удобный', 'удобная', 'неудобный',
            'возможный', 'возможная', 'невозможный',
            'верный', 'верная', 'неверный', 'неверная',
            'полный', 'полная', 'пустой', 'пустая',
            'открытый', 'открытая', 'закрытый', 'закрытая',
            'свободный', 'свободная', 'занятый', 'занятая',
            'готовый', 'готовая', 'готовые',
            'правильный', 'правильная', 'неправильный',
            'современный', 'современная', 'старомодный',
            'необходимый', 'необходимая', 'нужный',
            'технический', 'техническая', 'технологический',
            'профессиональный', 'профессиональная',
            'практический', 'практическая', 'теоретический',
            'реальный', 'реальная', 'нереальный', 'фактический',
            'прекрасный', 'прекрасная', 'отличный', 'отличная',
            'замечательный', 'замечательная', 'превосходный',
            'серьёзный', 'серьёзная', 'весёлый', 'весёлая',
            'спокойный', 'спокойная', 'нервный', 'нервная',
            'активный', 'активная', 'пассивный', 'пассивная',
            'позитивный', 'позитивная', 'негативный', 'негативная',
            'конкретный', 'конкретная', 'абстрактный',
            'прямой', 'прямая', 'косвенный',
            'первичный', 'первичная', 'вторичный', 'вторичная',
            'внутренний', 'внутренняя', 'внешний', 'внешняя',
            'местный', 'местная', 'общий', 'местное',
            'федеральный', 'федеральная', 'региональный',
            'национальный', 'национальная', 'международный',
            'социальный', 'социальная', 'экономический', 'экономическая',
            'политический', 'политическая', 'культурный', 'культурная',
            'исторический', 'историческая', 'географический',
            'биологический', 'химический', 'физический',
            'математический', 'логический', 'психологический',
            'медицинский', 'медицинская', 'юридический', 'юридическая',
            'коммерческий', 'коммерческая', 'финансовый', 'финансовая',
            
            # Глаголы частые
            'быть', 'есть', 'являться', 'оказываться', 'становиться',
            'иметь', 'обладать', 'владеть', 'пользоваться', 'использовать',
            'делать', 'сделать', 'выполнять', 'выполнить', 'осуществлять',
            'говорить', 'сказать', 'рассказывать', 'рассказать', 'объяснять',
            'знать', 'понимать', 'узнавать', 'узнать', 'учить', 'учиться',
            'думать', 'думать', 'считать', 'полагать', 'верить', 'надеяться',
            'видеть', 'смотреть', 'увидеть', 'замечать', 'наблюдать',
            'слышать', 'слушать', 'услышать',
            'читать', 'писать', 'переписывать', 'записывать',
            'брать', 'взять', 'давать', 'дать', 'получать', 'получить',
            'ходить', 'идти', 'приходить', 'прийти', 'уходить', 'уйти',
            'ездить', 'ехать', 'приезжать', 'приехать', 'уезжать', 'уехать',
            'бежать', 'бегать', 'лететь', 'летать', 'плавать', 'плыть',
            'стоять', 'сидеть', 'лежать', 'висеть', 'валяться',
            'жить', 'проживать', 'существовать', 'находиться', 'располагаться',
            'работать', 'трудиться', 'заниматься', 'устраиваться',
            'учиться', 'учить', 'обучаться', 'преподавать',
            'отдыхать', 'спать', 'лёг', 'легла', 'засыпать', 'просыпаться',
            'есть', 'кушать', 'пить', 'поить', 'кормить', 'питаться',
            'покупать', 'купить', 'продавать', 'продать', 'торговать',
            'платить', 'заплатить', 'тратить', 'потратить', 'копить',
            'искать', 'искал', 'искала', 'находить', 'найти',
            'терять', 'потерять', 'теряться', 'терял', 'теряла',
            'открывать', 'открыть', 'закрывать', 'закрыть',
            'начинать', 'начать', 'кончать', 'кончить', 'заканчивать',
            'продолжать', 'продолжить', 'останавливаться', 'остановиться',
            'входить', 'войти', 'выходить', 'выйти', 'приходить', 'прийти',
            'подходить', 'подойти', 'уходить', 'уйти', 'проходить', 'пройти',
            'возвращаться', 'вернуться', 'приходить', 'прийти',
            'спрашивать', 'спросить', 'отвечать', 'ответить',
            'звонить', 'позвонить', 'звать', 'позвать', 'кричать', 'крикнуть',
            'молчать', 'промолчать', 'говорить', 'сказать', 'повторять',
            'понимать', 'понять', 'осознавать', 'осознать',
            'забывать', 'забыть', 'помнить', 'вспоминать', 'вспомнить',
            'узнавать', 'узнать', 'узнавал', 'узнавала',
            'помогать', 'помочь', 'помог', 'помогла',
            'мешать', 'помешать', 'мешал', 'мешала',
            'любить', 'полюбить', 'нравиться', 'понравиться',
            'хотеть', 'захотеть', 'хотел', 'хотела', 'желать',
            'мочь', 'смочь', 'мог', 'могла', 'могли',
            'должен', 'должна', 'должны', 'должно',
            'нужно', 'нужен', 'нужна', 'нужны',
            'можно', 'нельзя', 'надо', 'необходимо',
            'давать', 'дать', 'дарить', 'подарить', 'отдавать', 'отдать',
            'брать', 'взять', 'забирать', 'забрать', 'отбирать', 'отобрать',
            'держать', 'подержать', 'держал', 'держала',
            'ловить', 'поймать', 'ловил', 'ловила',
            'бросать', 'бросить', 'кидать', 'кинуть',
            'падать', 'упасть', 'валиться', 'рушиться',
            'подниматься', 'подняться', 'поднимать', 'поднять',
            'опускаться', 'опуститься', 'опускать', 'опустить',
            'расти', 'вырасти', 'вырастать', 'уменьшаться', 'увеличиваться',
            'меняться', 'измениться', 'изменяться', 'превращаться', 'стать',
            'создавать', 'создать', 'творить', 'сотворить', 'делать', 'сделать',
            'строить', 'построить', 'строил', 'строила',
            'ломать', 'сломать', 'ломал', 'ломала',
            'чинить', 'починить', 'ремонтировать', 'отремонтировать',
            'чистить', 'почистить', 'мыть', 'помыть', 'стирать', 'постирать',
            'готовить', 'приготовить', 'варить', 'сварить', 'жарить', 'зажарить',
            'резать', 'порезать', 'резал', 'резала', 'крошить', 'покрошить',
            'кусать', 'укусить', 'кусал', 'кусала',
            'ударять', 'ударить', 'ударил', 'ударила', 'бить', 'побить',
            'трогать', 'тронуть', 'трогал', 'трогала', 'щупать', 'пощупать',
            'чувствовать', 'почувствовать', 'ощущать', 'почувствовал',
            'видеть', 'увидеть', 'видал', 'видела', 'зреть', 'узреть',
            'смотреть', 'посмотреть', 'смотрел', 'смотрела', 'глядеть', 'поглядеть',
            'следить', 'проследить', 'следил', 'следила', 'наблюдать', 'понаблюдать',
            'ждать', 'подождать', 'ждал', 'ждала', 'ожидать', 'предполагать',
            'надеяться', 'понадеяться', 'надеялся', 'надеялась',
            'бояться', 'побояться', 'боялся', 'боялась', 'страшиться',
            'радоваться', 'обрадоваться', 'радовался', 'радовалась',
            'грустить', 'погрустить', 'грустил', 'грустила', 'печалиться',
            'смеяться', 'рассмеяться', 'смеялся', 'смеялась', 'хохотать',
            'плакать', 'заплакать', 'плакал', 'плакала', 'рыдать',
            'улыбаться', 'улыбнуться', 'улыбался', 'улыбалась', 'сиять', 'сиял',
            'сердиться', 'рассердиться', 'сердился', 'сердилась', 'злиться', 'разозлиться',
            'удивляться', 'удивиться', 'удивлялся', 'удивлялась', 'изумляться',
            'волноваться', 'поволноваться', 'волновался', 'волновалась', 'беспокоиться',
            'успокаиваться', 'успокоиться', 'успокоил', 'успокоила',
            
            # Существительные частые
            'человек', 'человека', 'люди', 'людей', 'лицо', 'лица',
            'мужчина', 'мужчины', 'женщина', 'женщины', 'мальчик', 'мальчики',
            'девочка', 'девочки', 'ребёнок', 'ребёнка', 'дети', 'детей',
            'сын', 'сына', 'сыновья', 'дочь', 'дочери', 'дочка', 'родители',
            'мать', 'матери', 'мама', 'мамы', 'отец', 'отца', 'папа', 'папы',
            'брат', 'брата', 'братья', 'сестра', 'сестры', 'бабушка', 'дедушка',
            'семья', 'семьи', 'род', 'рода', 'родня', 'родственники',
            'друг', 'друга', 'друзья', 'подруга', 'подруги', 'товарищ', 'знакомый',
            'сосед', 'соседа', 'соседи', 'гость', 'гостя', 'гости',
            'хозяин', 'хозяина', 'хозяйка', 'господин', 'госпожа',
            'народ', 'народы', 'население', 'жители', 'граждане',
            'товарищ', 'коллега', 'коллеги', 'начальник', 'начальника', 'шеф', 'босс',
            'работник', 'работника', 'работники', 'сотрудник', 'сотрудники',
            'учитель', 'учителя', 'учительница', 'преподаватель', 'профессор',
            'врач', 'врача', 'доктор', 'медсестра', 'медбрат',
            'инженер', 'программист', 'менеджер', 'директор', 'бухгалтер',
            'юрист', 'адвокат', 'судья', 'полицейский', 'милиционер',
            'продавец', 'продавца', 'кассир', 'официант', 'официантка',
            'водитель', 'водителя', 'пилот', 'стюардесса', 'проводник',
            'дом', 'дома', 'квартира', 'квартиры', 'комната', 'комнаты',
            'кухня', 'кухни', 'ванная', 'туалет', 'прихожая', 'коридор',
            'окно', 'окна', 'дверь', 'двери', 'стена', 'стены', 'потолок', 'пол',
            'крыша', 'фундамент', 'лестница', 'балкон', 'лифт',
            'город', 'города', 'городок', 'посёлок', 'деревня', 'село',
            'страна', 'страны', 'государство', 'республика', 'область', 'край',
            'улица', 'улицы', 'проспект', 'проезд', 'переулок', 'площадь',
            'мост', 'мосты', 'туннель', 'дорога', 'дороги', 'трасса', 'шоссе',
            'машина', 'машины', 'автомобиль', 'автомобили', 'машинка',
            'автобус', 'троллейбус', 'трамвай', 'такси', 'метро',
            'поезд', 'поезда', 'вагон', 'вагоны', 'платформа', 'станция',
            'самолёт', 'самолёты', 'вертолёт', 'аэропорт', 'взлёт', 'посадка',
            'корабль', 'корабли', 'лодка', 'лодки', 'пароход', 'катер',
            'велосипед', 'велосипеды', 'мотоцикл', 'мопед', 'самокат',
            'время', 'времена', 'час', 'часы', 'минута', 'минуты', 'секунда',
            'день', 'дня', 'дни', 'неделя', 'недели', 'месяц', 'месяцы',
            'год', 'года', 'годы', 'век', 'века', 'время', 'эпоха', 'период',
            'утро', 'утра', 'день', 'днём', 'вечер', 'вечера', 'ночь', 'ночи',
            'сегодня', 'вчера', 'завтра', 'послезавтра', 'неделю', 'назад',
            'понедельник', 'вторник', 'среда', 'четверг', 'пятница', 'суббота', 'воскресенье',
            'январь', 'февраль', 'март', 'апрель', 'май', 'июнь',
            'июль', 'август', 'сентябрь', 'октябрь', 'ноябрь', 'декабрь',
            'зима', 'весна', 'лето', 'осень',
            'вещь', 'вещи', 'предмет', 'предметы', 'объект', 'объекты',
            'продукт', 'продукты', 'товар', 'товары', 'вещество', 'вещества',
            'еда', 'пища', 'кухня', 'блюдо', 'блюда', 'кушанье',
            'хлеб', 'масло', 'молоко', 'мясо', 'рыба', 'курица', 'яйцо',
            'сыр', 'творог', 'сметана', 'йогурт', 'кефир',
            'фрукт', 'фрукты', 'яблоко', 'яблоки', 'груша', 'груши',
            'апельсин', 'мандарин', 'лимон', 'банан', 'виноград',
            'овощ', 'овощи', 'картошка', 'морковь', 'лук', 'чеснок',
            'огурец', 'помидор', 'перец', 'капуста', 'свёкла',
            'суп', 'супы', 'борщ', 'щи', 'каша', 'каши', 'макароны',
            'вода', 'воды', 'сок', 'соки', 'чай', 'кофе', 'какао',
            'сахар', 'соль', 'перец', 'мука', 'рис', 'гречка',
            'одежда', 'одежды', 'платье', 'платья', 'костюм', 'костюмы',
            'рубашка', 'рубашки', 'брюки', 'джинсы', 'юбка', 'юбки',
            'куртка', 'куртки', 'пальто', 'плащ', 'шуба', 'шубы',
            'обувь', 'туфли', 'ботинки', 'сапоги', 'кроссовки', 'тапочки',
            'шапка', 'шапки', 'шарф', 'перчатки', 'варежки',
            'цвет', 'цвета', 'красный', 'синий', 'зелёный', 'жёлтый',
            'белый', 'чёрный', 'серый', 'коричневый', 'оранжевый', 'фиолетовый',
            'форма', 'формы', 'размер', 'размеры', 'вес', 'длина', 'ширина',
            'высота', 'глубина', 'объём', 'площадь', 'масса',
            'часть', 'части', 'доля', 'кусок', 'куски', 'половина', 'четверть',
            'группа', 'группы', 'команда', 'команды', 'отряд', 'бригада',
            'система', 'системы', 'сеть', 'сети', 'структура', 'структуры',
            'процесс', 'процессы', 'этап', 'этапы', 'стадия', 'стадии',
            'проблема', 'проблемы', 'вопрос', 'вопросы', 'задача', 'задачи',
            'тема', 'темы', 'предмет', 'предметы', 'область', 'области', 'сфера',
            'цель', 'цели', 'задача', 'задачи', 'план', 'планы', 'программа',
            'результат', 'результаты', 'итог', 'итоги', 'вывод', 'выводы',
            'причина', 'причины', 'следствие', 'следствия', 'цель', 'цели',
            'начало', 'начала', 'конец', 'концы', 'середина', 'середины',
            'суть', 'сути', 'содержание', 'смысл', 'значение', 'значения',
            'идея', 'идеи', 'мысль', 'мысли', 'понятие', 'понятия',
            'способ', 'способы', 'метод', 'методы', 'приём', 'приёмы',
            'средство', 'средства', 'инструмент', 'инструменты', 'орудие',
            'условие', 'условия', 'требование', 'требования', 'правило', 'правила',
            'закон', 'законы', 'норма', 'нормы', 'принцип', 'принципы',
            'мера', 'меры', 'степень', 'уровень', 'уровни', 'стандарт',
            'качество', 'качества', 'свойство', 'свойства', 'признак', 'признаки',
            'вид', 'виды', 'тип', 'типы', 'форма', 'формы', 'класс', 'классы',
            'разряд', 'категория', 'категории', 'классификация', 'сорт',
            'пример', 'примеры', 'образец', 'образцы', 'экземпляр', 'экземпляры',
            'аналог', 'аналоги', 'вариант', 'варианты', 'альтернатива', 'выбор',
            'возможность', 'возможности', 'шанс', 'шансы', 'попытка', 'попытки',
            'успех', 'удача', 'победа', 'провал', 'неудача', 'поражение',
            'счастье', 'радость', 'веселье', 'восторг', 'удовольствие',
            'горе', 'печаль', 'страдание', 'тоска', 'разочарование',
            'страх', 'ужас', 'испуг', 'тревога', 'волнение', 'беспокойство',
            'гнев', 'ярость', 'злость', 'раздражение', 'недовольство',
            'любовь', 'любви', 'нежность', 'привязанность', 'симпатия',
            'ненависть', 'отвращение', 'враждебность', 'зависть', 'ревность',
            'дружба', 'друзья', 'приятель', 'приятели', 'знакомый', 'знакомые',
            'уважение', 'почёт', 'авторитет', 'влияние', 'власть', 'сила',
            'слабость', 'бессилие', 'зависимость', 'подчинение', 'подчинённость',
            'свобода', 'свободы', 'независимость', 'самостоятельность', 'автономия',
            'ответственность', 'долг', 'обязанность', 'обязательство',
            'честь', 'достоинство', 'совесть', 'честность', 'правдивость',
            'добро', 'зло', 'справедливость', 'несправедливость',
            'красота', 'уродство', 'эстетика', 'гармония', 'пропорция',
            'истина', 'ложь', 'обман', 'ошибка', 'заблуждение', 'иллюзия',
            'реальность', 'действительность', 'факт', 'событие', 'явление',
            'природа', 'природы', 'мир', 'миры', 'вселенная', 'космос',
            'земля', 'земли', 'земля', 'почва', 'грунт', 'территория',
            'небо', 'небеса', 'солнце', 'луна', 'звезда', 'звёзды',
            'воздух', 'атмосфера', 'ветер', 'дождь', 'снег', 'туман',
            'огонь', 'пламя', 'вода', 'льд', 'пар', 'дым',
            'камень', 'камни', 'песок', 'грязь', 'глина', 'пыль',
            'дерево', 'деревья', 'лес', 'леса', 'куст', 'кусты', 'трава',
            'цветок', 'цветы', 'растение', 'растения', 'животное', 'животные',
            'птица', 'птицы', 'рыба', 'рыбы', 'насекомое', 'насекомые',
            'человечество', 'общество', 'цивилизация', 'культура', 'история',
            'язык', 'языки', 'речь', 'слово', 'слова', 'текст', 'тексты',
            'письмо', 'письма', 'письменность', 'литература', 'искусство',
            'музыка', 'песня', 'песни', 'танец', 'танцы', 'живопись',
            'наука', 'науки', 'знание', 'знания', 'образование', 'учёба',
            'техника', 'технологии', 'промышленность', 'производство',
            'торговля', 'коммерция', 'бизнес', 'предпринимательство',
            'экономика', 'финансы', 'деньги', 'валюта', 'банк', 'банки',
            'рынок', 'рынки', 'магазин', 'магазины', 'фирма', 'фирмы',
            'компания', 'компании', 'организация', 'организации', 'учреждение',
            'государство', 'власть', 'политика', 'правительство', 'администрация',
            'закон', 'законы', 'право', 'суд', 'судебный', 'арест', 'тюрьма',
            'армия', 'войска', 'воин', 'воины', 'солдат', 'солдаты',
            'война', 'войны', 'битва', 'сражение', 'мир', 'перемирие',
            'здоровье', 'болезнь', 'болезни', 'лекарство', 'лекарства',
            'спорт', 'спорты', 'игра', 'игры', 'матч', 'соревнование',
            'отдых', 'каникулы', 'праздник', 'праздники', 'юбилей',
            'подарок', 'подарки', 'сюрприз', 'сюрпризы', 'празднование',
            
            # Имена собственные (распространённые)
            'андрей', 'андрея', 'александр', 'александра', 'сергей', 'сергея',
            'дмитрий', 'дмитрия', 'николай', 'николая', 'владимир', 'владимира',
            'иван', 'ивана', 'пётр', 'петра', 'михаил', 'михаила',
            'алексей', 'алексея', 'максим', 'максима', 'артём', 'артёма',
            'даниил', 'даниила', 'кирилл', 'кирилла', 'матвей', 'матвея',
            'елена', 'елены', 'ольга', 'ольги', 'мария', 'марии',
            'анна', 'анны', 'надежда', 'надежды', 'людмила', 'людмилы',
            'татьяна', 'татьяны', 'светлана', 'светланы', 'ирина', 'ирины',
            'екатерина', 'екатерины', 'виктория', 'виктории', 'алина', 'алины',
            'москва', 'москвы', 'питер', 'петербург', 'спб',
            'россия', 'россии', 'русь', 'руси', 'советский', 'ссср',
            'европа', 'европы', 'азия', 'америка', 'африка', 'австралия',
            'англия', 'франция', 'германия', 'италия', 'испания', 'польша',
            'украина', 'белоруссия', 'казахстан', 'грузия', 'армения',
            'китай', 'япония', 'корея', 'индия', 'турция', 'египет',
            'сша', 'сша', 'канада', 'мексика', 'бразилия', 'аргентина',
            
            # Сайты и бренды
            'авито', 'яндекс', 'гугл', 'google', 'youtube', 'ютуб',
            'вконтакте', 'vk', 'facebook', 'фейсбук', 'instagram', 'инстаграм',
            'twitter', 'твиттер', 'telegram', 'телеграм', 'whatsapp', 'ватсап',
            'twitch', 'твич', 'tiktok', 'тикток', 'ozon', 'озон',
            'wildberries', 'вайлдберриз', 'aliexpress', 'алиэкспресс',
            'сбер', 'сбербанк', 'тинькофф', 'альфа', 'втб', 'газпром',
            'роснефть', 'лукойл', 'мтс', 'мегафон', 'билайн', 'теле2',
            
            # Профессии и должности
            'менеджер', 'менеджера', 'менеджеры', 'руководитель', 'руководители',
            'специалист', 'специалисты', 'эксперт', 'эксперты', 'консультант',
            'аналитик', 'разработчик', 'программист', 'тестировщик', 'дизайнер',
            'маркетолог', 'smm', 'seo', 'копирайтер', 'редактор', 'журналист',
            'бухгалтер', 'экономист', 'финансист', 'аудитор', 'юрист', 'адвокат',
            'менеджер', 'продавец', 'кассир', 'оператор', 'администратор',
            'охранник', 'водитель', 'курьер', 'уборщица', 'горничная',
            
            # Технические термины (русские)
            'компьютер', 'компьютера', 'ноутбук', 'ноутбука', 'планшет', 'телефон',
            'смартфон', 'айфон', 'iphone', 'android', 'андроид', 'windows',
            'виндовс', 'linux', 'линукс', 'программа', 'приложение', 'приложения',
            'сайт', 'сайты', 'сервис', 'сервисы', 'платформа', 'платформы',
            'база', 'базы', 'данные', 'информация', 'контент', 'контенты',
            'файл', 'файлы', 'документ', 'документы', 'папка', 'папки',
            'пароль', 'логин', 'аккаунт', 'профиль', 'страница', 'страницы',
            'ссылка', 'ссылки', 'кнопка', 'кнопки', 'форма', 'формы',
            'загрузка', 'скачивание', 'установка', 'настройка', 'обновление',
            'версия', 'версии', 'лицензия', 'лицензии', 'подписка', 'подписки',
            'тариф', 'тарифы', 'бесплатный', 'платный', 'триал', 'демо',
            'сервер', 'сервера', 'хостинг', 'домен', 'домены', 'ip', 'айпи',
            'браузер', 'браузеры', 'chrome', 'король', 'firefox', 'файрфокс',
            'edge', 'эдж', 'safari', 'сафари', 'opera', 'опера',
            'поиск', 'поиски', 'результат', 'результаты', 'фильтр', 'фильтры',
            'сортировка', 'сортировки', 'категория', 'категории', 'раздел',
            
            # Маркетинг и бизнес
            'бизнес', 'бизнеса', 'бизнесы', 'компания', 'компании', 'фирма',
            'стартап', 'стартапы', 'проект', 'проекты', 'заказ', 'заказы',
            'клиент', 'клиенты', 'заказчик', 'заказчики', 'партнёр', 'партнёры',
            'инвестор', 'инвесторы', 'спонсор', 'спонсоры', 'рекламодатель',
            'продажа', 'продажи', 'покупка', 'покупки', 'закупка', 'закупки',
            'предложение', 'предложения', 'спрос', 'цена', 'цены', 'стоимость',
            'скидка', 'скидки', 'распродажа', 'акция', 'акции', 'бонус',
            'кэшбэк', 'кэшбек', 'кешбэк', 'баллы', 'промокод', 'купон',
            'доставка', 'доставки', 'самовывоз', 'курьер', 'курьеры',
            'оплата', 'оплаты', 'наличные', 'карта', 'карты', 'перевод',
            'счёт', 'счета', 'чек', 'чеки', 'накладная', 'счет-фактура',
            'договор', 'договоры', 'соглашение', 'соглашения', 'контракт',
            'гарантия', 'гарантии', 'возврат', 'обмен', 'отмена', 'отмены',
            'отзыв', 'отзывы', 'рейтинг', 'рейтинги', 'оценка', 'оценки',
            'популярный', 'популярная', 'рекомендуемый', 'хит', 'хиты',
            'новинка', 'новинки', 'топ', 'тренд', 'тренды', 'хайп',
            
            # Глаголы-бизнес
            'заказывать', 'заказать', 'покупать', 'купить', 'продавать', 'продать',
            'приобретать', 'приобрести', 'оплачивать', 'оплатить', 'расплачиваться',
            'регистрироваться', 'зарегистрироваться', 'оформлять', 'оформить',
            'подписываться', 'подписаться', 'оформлять', 'оформить', 'заполнять',
            'отправлять', 'отправить', 'получать', 'получить', 'ждать', 'дожидаться',
            'возвращать', 'вернуть', 'обменивать', 'обменять', 'отменять', 'отменить',
            'бронировать', 'забронировать', 'резервировать', 'зарезервировать',
            'проверять', 'проверить', 'подтверждать', 'подтвердить', 'уточнять',
            'звонить', 'позвонить', 'писать', 'написать', 'спрашивать', 'спросить',
            'жаловаться', 'пожаловаться', 'благодарить', 'поблагодарить', 'рекомендовать',
            'советовать', 'посоветовать', 'предлагать', 'предложить', 'соглашаться',
            'отказываться', 'отказаться', 'выбирать', 'выбрать', 'сравнивать',
            'искать', 'находить', 'найти', 'терять', 'потерять', 'хранить',
            'сохранять', 'сохранить', 'загружать', 'загрузить', 'скачивать',
            'обновлять', 'обновить', 'менять', 'поменять', 'настраивать',
            'включать', 'включить', 'выключать', 'выключить', 'открывать',
            'закрывать', 'закрыть', 'добавлять', 'добавить', 'удалять', 'удалить',
            'создавать', 'создать', 'составлять', 'составить', 'готовить',
            'оформлять', 'оформить', 'выполнять', 'выполнить', 'завершать',
            'начинать', 'начать', 'продолжать', 'продолжить', 'останавливаться',
            'работать', 'трудиться', 'заниматься', 'зарабатывать', 'заработать',
            'тратить', 'потратить', 'экономить', 'сэкономить', 'копить', 'накопить',
            'инвестировать', 'вкладывать', 'вложить', 'снимать', 'снять',
            'переводить', 'перевести', 'платить', 'заплатить', 'оплачивать',
            'возвращать', 'вернуть', 'отдавать', 'отдать', 'занимать', 'занять',
            'давать', 'дать', 'брать', 'взять', 'одалживать', 'одолжить',
        }
        self.normative_words.update(common)
        print(f"[OK] Base dictionary: {len(common)} words")

    def _get_normal_form(self, word_lower):
        """Получить нормальную форму с кэшированием"""
        if word_lower in self._normal_form_cache:
            return self._normal_form_cache[word_lower]

        if not self.morph:
            return word_lower

        try:
            parsed = self.morph.parse(word_lower)
            if parsed:
                normal = parsed[0].normal_form
                self._normal_form_cache[word_lower] = normal
                return normal
        except:
            pass

        self._normal_form_cache[word_lower] = word_lower
        return word_lower

    def _is_known_fast(self, word_lower):
        """Мгновенная проверка - только словари"""
        if word_lower in self.all_forms:
            return True
        if word_lower in self.normative_words:
            self.all_forms.add(word_lower)
            return True
        return False

    def deep_check_words(self, words):
        """Глубокая проверка списка слов с кэшированием"""
        results = []
        for word in words:
            result = self._deep_check_single(word)
            results.append(result)
        return results

    def _deep_check_single(self, word):
        """Глубокая проверка одного слова"""
        word_lower = word.lower()
        
        if word_lower in self._normal_form_cache:
            cached = self._normal_form_cache[word_lower]
            return cached.copy()

        result = {
            'word': word,
            'is_valid': False,
            'reasons': [],
            'normal_form': None,
            'suggestions': []
        }

        if self._is_abbreviation(word):
            result['is_valid'] = True
            result['reasons'].append('abbreviation')
            translations = self.abbreviations.get(word.upper(), [])
            if translations:
                result['suggestions'] = translations
            else:
                result['suggestions'].append('требуется перевод')
            self._normal_form_cache[word_lower] = result.copy()
            return result

        morph_result = self._check_morph_full(word_lower)
        if morph_result:
            result['normal_form'] = morph_result['normal_form']
            if morph_result['found']:
                result['is_valid'] = True
                result['reasons'].append(morph_result['reason'])

        if not result['is_valid'] and self.speller and PYASPELLER_AVAILABLE:
            speller_result = self._check_speller_full(word)
            if speller_result:
                result['suggestions'] = speller_result.get('variants', [])
                if speller_result.get('correct'):
                    result['is_valid'] = True
                    result['reasons'].append('speller_confirmed')

                if not result['is_valid'] and speller_result.get('variants'):
                    for variant in speller_result['variants'][:3]:
                        if self._is_known_fast(variant.lower()):
                            result['is_valid'] = True
                            result['reasons'].append(f'speller_variant: {variant}')
                            result['suggestions'] = [variant]
                            break

        self._normal_form_cache[word_lower] = result.copy()
        return result

    def _check_morph_full(self, word_lower):
        """Глубокая проверка через морфологию"""
        if not self.morph:
            return None
        
        if word_lower in self.forms_cache:
            return self.forms_cache[word_lower]

        try:
            parsed = self.morph.parse(word_lower)
            if not parsed:
                return None

            p = parsed[0]
            normal = p.normal_form

            if normal in self.normative_words:
                result = {'found': True, 'normal_form': normal, 'reason': 'normal_form_in_dict'}
                self.forms_cache[word_lower] = result
                return result

            tag = str(p.tag)
            
            if 'Name' in tag or 'Surn' in tag or 'Patr' in tag:
                result = {'found': True, 'normal_form': normal, 'reason': 'proper_name'}
                self.forms_cache[word_lower] = result
                return result

            if 'Geox' in tag:
                result = {'found': True, 'normal_form': normal, 'reason': 'geo_name'}
                self.forms_cache[word_lower] = result
                return result

            if 'Orgn' in tag:
                result = {'found': True, 'normal_form': normal, 'reason': 'organization'}
                self.forms_cache[word_lower] = result
                return result

            result = {'found': False, 'normal_form': normal, 'reason': 'unknown'}
            self.forms_cache[word_lower] = result
            return result

        except:
            return None

    def _check_speller_full(self, word):
        """Глубокая проверка через speller"""
        if not self.speller or not PYASPELLER_AVAILABLE:
            return None

        word_lower = word.lower()

        if word_lower in self.speller_cache:
            return self.speller_cache[word_lower]

        try:
            result = self.speller.spelled(word_lower)
            is_correct = (result == word_lower)
            variants = []

            if not is_correct:
                try:
                    variants = self.speller.suggest(word_lower)[:5]
                except:
                    pass

            speller_result = {'correct': is_correct, 'variants': variants}
            self.speller_cache[word_lower] = speller_result
            return speller_result

        except:
            return None

    def load_dictionaries(self):
        """Load dictionaries from files - с автораспаковкой .gz"""
        import gzip
        
        possible_paths = [
            Path('dictionaries'),
            Path('.') / 'dictionaries',
            Path(__file__).parent / 'dictionaries',
            Path.cwd() / 'dictionaries',
        ]

        dict_path = None
        for path in possible_paths:
            if path.exists() and path.is_dir():
                dict_path = path
                break

        if not dict_path:
            return

        files_to_load = {
            'russian_dict.txt.gz': 'normative_words',
        }
        
        # Загружаем основной словарь
        loaded = 0
        for filename, target_attr in files_to_load.items():
            filepath = dict_path / filename
            
            if not filepath.exists():
                continue

            try:
                with gzip.open(filepath, 'rt', encoding='utf-8') as f:
                    words = set()
                    for line in f:
                        word = line.strip().lower()
                        if word and len(word) > 1:
                            words.add(word)
                
                if words:
                    getattr(self, target_attr).update(words)
                    loaded += 1
            except Exception as e:
                print(f"[ERROR] {filename}: {e}")

        # Минимальные списки - хардкод для быстрого старта
        self.foreign_allowed.update({
            'hello', 'world', 'web', 'site', 'internet', 'email', 'login',
            'software', 'hardware', 'server', 'client', 'proxy', 'wifi',
            'api', 'json', 'xml', 'html', 'css', 'js', 'java', 'python',
            ' бизнес', 'маркетинг', 'hr', 'it', 'seo', 'smm', 'crm', 'erp',
            'ai', 'ml', 'tv', 'vip', 'ok', 'gdz', 'hit', 'top', 'best',
            'show', 'news', 'chat', 'bot', 'user', 'admin', 'root', 'sudo',
            'cd', 'ls', 'cat', 'grep', 'ssh', 'ftp', 'dns', 'ip', 'url',
            'cookie', 'bug', 'debug', 'stack', 'heap', 'byte', 'bit', 'mbyte',
            'gbyte', 'terabyte', 'pixel', 'matrix', 'kernel', 'driver', 'patch',
            'login', 'password', 'token', 'hash', 'md5', 'sha', 'aes', 'rsa',
            'wifi', 'bluetooth', 'usb', 'hdmi', 'vga', 'dvi', 'ram', 'cpu', 'gpu',
            'hdd', 'ssd', 'nvme', 'pci', 'agp', 'bios', 'uefi', 'firmware',
            'html', 'http', 'https', 'ftp', 'smtp', 'pop3', 'imap', 'tcp', 'udp',
            'os', 'bios', 'dos', 'unix', 'linux', 'windows', 'macos', 'android', 'ios',
            'gpl', 'mit', 'apache', 'nginx', 'docker', 'kubernetes', 'k8s',
            'git', 'svn', 'hg', 'cvs', 'bzr', 'ppa', 'apt', 'yum', 'rpm',
            'npm', 'yarn', 'pip', 'conda', 'venv', 'poetry', 'make', 'cmake',
            'gcc', 'clang', 'llvm', 'gdb', 'valgrind', 'perf', 'strace', 'ltrace',
            'tcpdump', 'wireshark', 'nmap', 'ping', 'traceroute', 'dig', 'nslookup',
            'who', 'finger', 'id', 'w', 'last', 'history', 'alias', 'export',
            'env', 'var', 'cd', 'pwd', 'ls', 'mkdir', 'rm', 'cp', 'mv', 'ln',
            'chmod', 'chown', 'chgrp', 'sudo', 'su', 'useradd', 'usermod', 'userdel',
            'groupadd', 'groupmod', 'groupdel', 'passwd', 'shadow', 'gshadow',
            'cron', 'at', 'batch', 'nice', 'renice', 'ionice', 'ulimit',
            'ulimit', 'nice', 'cpulimit', 'cgroups', 'namespaces', 'cgroups',
            'docker', 'container', 'image', 'registry', 'hub', 'compose',
            'kubernetes', 'pod', 'service', 'deployment', 'daemonset', 'statefulset',
            'helm', 'kubectl', 'oc', 'istio', 'linkerd', 'envoy', 'traefik', 'nginx',
            'elk', 'efk', 'prometheus', 'grafana', 'zabbix', 'nagios', 'icinga',
            'splunk', 'sumologic', 'datadog', 'newrelic', 'appdynamics', 'dynatrace',
            'slack', 'telegram', 'discord', 'zoom', 'teams', 'meet', 'webex',
            'aws', 'azure', 'gcp', 'digitalocean', 'linode', 'vultr', 'hetzner',
            'ec2', 's3', 'ebs', 'efs', 'rds', 'dynamodb', 'lambda', 'ecs', 'eks',
            'cloudfront', 'route53', 'vpc', 'subnet', 'sg', 'nacl', 'iam', 'sts',
            'bucket', 'key', 'secret', 'access', 'token', 'session', 'cookie',
            'jwt', 'oauth', 'openid', 'saml', 'ldap', 'kerberos', 'ntlm',
            'ssl', 'tls', 'https', 'cert', 'ca', 'crl', 'ocsp', 'pkcs',
            'aes', 'rsa', 'dsa', 'ecdsa', 'sha', 'md5', 'hmac', 'pbkdf2', 'bcrypt',
            'sql', 'mysql', 'postgresql', 'postgres', 'sqlite', 'mongodb', 'redis',
            'elasticsearch', 'cassandra', 'hbase', 'kafka', 'rabbitmq', 'activemq',
            'zookeeper', 'etcd', 'consul', 'vault', 'secure', 'auth', 'authz',
            'iam', 'rbac', 'abac', 'policies', 'roles', 'users', 'groups',
            'jwt', 'jws', 'jwe', 'jwk', 'jwks', 'openid', 'oauth', 'sso', 'saml',
            'graphql', 'rest', 'soap', 'grpc', 'thrift', 'avro', 'protobuf', 'flatbuffers',
            'aws', 'gcp', 'azure', 'alibaba', 'tencent', 'yandex', 'mailru', 'vk',
            'ok', 'facebook', 'twitter', 'instagram', 'tiktok', 'youtube', 'twitch',
            'amazon', 'ebay', 'aliexpress', 'walmart', 'target', 'bestbuy', 'costco',
            'visa', 'mastercard', 'amex', 'paypal', 'stripe', 'square', 'payoneer',
            'wise', 'transferwise', 'westernunion', 'moneygram', 'swift', 'sepa', 'iban',
            'bitcoin', 'ethereum', 'litecoin', 'ripple', 'cardano', 'solana', 'polkadot',
            'binance', 'coinbase', 'kraken', 'bitfinex', 'huobi', 'okex', 'bybit',
            'nft', 'dao', 'defi', 'yield', 'staking', 'liquidity', 'swap', 'bridge',
            'metamask', 'trustwallet', 'ledger', 'trezor', 'coldwallet', 'hotwallet',
            'ico', 'ido', 'igo', 'ieo', 'sto', 'securitytoken', 'utilitytoken',
        })
        
        self.nenormative_words.update({
            'хуй', 'пизда', 'блядь', 'сука', 'ебать', 'нахуй', 'похуй', 'нахрен',
            ' fuck', 'shit', 'damn', 'ass', 'bitch', 'bastard', 'cunt', 'dick',
            'cock', 'pussy', 'slut', 'whore', 'fag', 'nigger', 'chink', 'spic',
            'уебан', 'уёбок', 'пидорас', 'пидарас', 'педик', 'педераст', 'гомик',
            'чмо', 'быдло', 'долбоёб', 'долбаёб', 'мудак', 'мудень', 'придурок',
            'дебил', 'имбецил', 'идиот', 'тупой', 'тупица', 'кретин', 'дегенерат',
            'выблядок', 'выхухоль', 'пиздец', 'пиздатый', 'охуенный', 'охуеть',
            'ебанутый', 'ебанутая', 'ебануться', 'пиздануть', 'вздрочить', 'дрочить',
            'пососать', 'отсосать', 'сосать', 'лизнуть', 'ли舐ть', 'шлюха', 'проститутка',
            'мамка', 'папка', 'сынок', 'дочка', 'сестра', 'брат', 'теща', 'свёкор',
            ' тесть', 'зять', 'невестка', 'сноха', 'дядя', 'тётя', 'кум', 'кума',
            'голубой', 'розовый', 'жёлтый', 'педерастия', 'гомосек', 'лесбиянка',
        })

        self.abbreviations.update({
            'VIP': ['очень важная персона', 'вип'],
            'CEO': ['главный исполнительный директор'],
            'CTO': ['технический директор'],
            'CFO': ['финансовый директор'],
            'COO': ['операционный директор'],
            'CMO': ['маркетинговый директор'],
            'HR': ['человеческие ресурсы', 'отдел кадров'],
            'IT': ['информационные технологии'],
            'AI': ['искусственный интеллект'],
            'ML': ['машинное обучение'],
            'NLP': ['обработка естественного языка'],
            'CV': ['компьютерное зрение'],
            'API': ['программный интерфейс'],
            'JSON': ['формат обмена данными'],
            'XML': ['расширяемый язык разметки'],
            'HTML': ['язык разметки гипертекста'],
            'CSS': ['каскадные таблицы стилей'],
            'JS': ['яваскрипт'],
            'SQL': ['язык структурированных запросов'],
            'URL': ['адрес ресурса'],
            'HTTP': ['протокол передачи гипертекста'],
            'HTTPS': ['защищённый протокол'],
            'FTP': ['протокол передачи файлов'],
            'SSH': ['защищённая оболочка'],
            'DNS': ['система доменных имён'],
            'IP': ['интернет-протокол'],
            'TCP': ['протокол управления передачей'],
            'UDP': ['протокол дейтаграмм'],
            'VPN': ['виртуальная частная сеть'],
            'LAN': ['локальная сеть'],
            'WAN': ['глобальная сеть'],
            'WLAN': ['беспроводная локальная сеть'],
            'WiFi': ['беспроводная сеть'],
            'OS': ['операционная система'],
            'CPU': ['центральный процессор'],
            'GPU': ['графический процессор'],
            'RAM': ['оперативная память'],
            'ROM': ['постоянная память'],
            'HDD': ['жёсткий диск'],
            'SSD': ['твёрдотельный накопитель'],
            'USB': ['универсальная последовательная шина'],
            'HDMI': ['мультимедийный интерфейс'],
            'VGA': ['видеографический массив'],
            'SEO': ['поисковая оптимизация'],
            'SMM': ['маркетинг в социальных сетях'],
            'CRM': ['управление отношениями с клиентами'],
            'ERP': ['планирование ресурсов предприятия'],
            'B2B': ['бизнес для бизнеса'],
            'B2C': ['бизнес для потребителя'],
            'C2C': ['потребитель для потребителя'],
            'O2O': ['онлайн для офлайна'],
            'KPI': ['ключевой показатель эффективности'],
            'ROI': ['возврат инвестиций'],
            'ROAS': ['возврат рекламных расходов'],
            'CPA': ['оплата за действие'],
            'CPC': ['оплата за клик'],
            'CPM': ['оплата за показ'],
            'CTR': ['показатель кликабельности'],
            'CR': ['конверсия'],
            'UV': ['уникальный посетитель'],
            'PV': ['просмотр страницы'],
            'DAU': ['активные пользователи в день'],
            'MAU': ['активные пользователи в месяц'],
            'LTV': ['пожизненная ценность'],
            'CAC': ['стоимость привлечения'],
            'GMV': ['общий товарооборот'],
            'MRR': ['регулярный месячный доход'],
            'ARR': ['регулярный годовой доход'],
            'EBITDA': ['прибыль до вычета процентов'],
            'P&L': ['прибыли и убытки'],
            'OKR': ['цели и ключевые результаты'],
            'SLA': ['соглашение об уровне услуг'],
            'SLO': ['целевой уровень услуг'],
            'SLI': ['индикатор уровня услуг'],
            'CI/CD': ['непрерывная интеграция и доставка'],
            'DevOps': ['разработка и эксплуатация'],
            'Agile': ['гибкая методология'],
            'Scrum': ['скрам'],
            'Kanban': ['канбан'],
            'MVP': ['минимальный жизнеспособный продукт'],
            'PMF': ['соответствие продукта рынку'],
            'UX': ['пользовательский опыт'],
            'UI': ['пользовательский интерфейс'],
            'GA': ['Google Analytics'],
            'GTM': ['выход на рынок'],
            'SaaS': ['программное обеспечение как услуга'],
            'PaaS': ['платформа как услуга'],
            'IaaS': ['инфраструктура как услуга'],
            'FOSS': ['свободное программное обеспечение'],
            'OSS': ['программное обеспечение с открытым кодом'],
            'GPL': ['общественная лицензия GNU'],
            'MIT': ['лицензия MIT'],
            'Apache': ['лицензия Apache'],
            'BSD': ['лицензия BSD'],
            'LGPL': ['меньшая общественная лицензия GNU'],
        })

        self.all_forms = set(self.normative_words)
        self.all_forms.update(self.foreign_allowed)
        print(f"[OK] Ready with {len(self.all_forms):,} total forms")
    
    def is_known_word(self, word):
        """Мгновенная проверка - только словари"""
        return self._is_known_fast(word.lower())

    def get_word_normal_form(self, word):
        return word.lower()

    def get_all_normal_forms(self, word):
        return {word.lower()}

    def is_nenormative(self, word):
        """Проверка ненормативности - с кэшем нормальных форм"""
        word_lower = word.lower()

        if word_lower in self.nenormative_words:
            return True

        if self.morph:
            normal = self._get_normal_form(word_lower)
            if normal in self.nenormative_words:
                return True

        return False

    def check_text(self, text):
        """Быстрая проверка текста - O(1) на слово"""
        if not text or not text.strip():
            return {
                'latin_words': [],
                'unknown_cyrillic': [],
                'nenormative_words': [],
                'latin_count': 0,
                'unknown_count': 0,
                'nenormative_count': 0,
                'violations_count': 0,
                'law_compliant': True,
                'total_words': 0,
                'unique_words': 0
            }

        text = _RE_URL.sub(' ', text)
        text = _RE_PHONE.sub(' ', text)

        all_words = _RE_WORD.findall(text)

        latin_words = set()
        unknown_cyrillic = set()
        nenormative_found = set()

        skip = frozenset({'и', 'в', 'на', 'по', 'от', 'до', 'из', 'к', 'с', 'у', 'о',
                         'но', 'да', 'не', 'за', 'об', 'во', 'а', 'я'})

        for word in all_words:
            wlower = word.lower()
            if len(wlower) <= 1 or wlower in skip:
                continue

            if self.is_nenormative(word):
                nenormative_found.add(word)
                continue

            if _RE_LATIN.search(word):
                latin_words.add(word)
                continue

            if not self._is_known_fast(wlower):
                unknown_cyrillic.add(word)

        return {
            'latin_words': sorted(latin_words),
            'unknown_cyrillic': sorted(unknown_cyrillic),
            'nenormative_words': sorted(nenormative_found),
            'latin_count': len(latin_words),
            'unknown_count': len(unknown_cyrillic),
            'nenormative_count': len(nenormative_found),
            'violations_count': len(latin_words) + len(unknown_cyrillic) + len(nenormative_found),
            'law_compliant': not (latin_words or unknown_cyrillic or nenormative_found),
            'total_words': len(all_words),
            'unique_words': len(set(all_words))
        }


# Test on run
if __name__ == "__main__":
    print("\n" + "="*60)
    print("TESTING RussianLanguageChecker (FAST + DEEP)")
    print("="*60)

    checker = RussianLanguageChecker()

    test_text = "Это тестовый текст для проверки. Hello world! Профессиональный подход."

    print(f"\nTest text: {test_text}")

    print("\n=== FAST CHECK ===")
    result = checker.check_text(test_text)
    print(f"Total words: {result['total_words']}")
    print(f"Unknown words: {result['unknown_cyrillic']}")
    print(f"Latin words: {result['latin_words']}")

    if result['unknown_cyrillic']:
        print("\n=== DEEP CHECK ===")
        deep_results = checker.deep_check_words(result['unknown_cyrillic'])
        for r in deep_results:
            status = "VALID" if r['is_valid'] else "UNKNOWN"
            print(f"  '{r['word']}' -> {status}")
            if r['reasons']:
                print(f"    Reasons: {r['reasons']}")
            if r['normal_form']:
                print(f"    Normal form: {r['normal_form']}")
            if r['suggestions']:
                print(f"    Suggestions: {r['suggestions']}")

    print("\n" + "="*60)
    print("TEST COMPLETE")
    print("="*60 + "\n")
