<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Metrics - LawChecker Online</title>
    <meta name="description" content="–°–µ—Ä–≤–∏—Å–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏ LawChecker: –∑–∞–ø—Ä–æ—Å—ã, –æ—à–∏–±–∫–∏, —Å–∫–æ—Ä–æ—Å—Ç—å, —Ç–æ–ø-—Å–ª–æ–≤–∞ –∏ –∏—Å—Ç–æ—Ä–∏—è –∑–∞–ø—É—Å–∫–æ–≤.">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <header class="header">
        <div class="container">
            <div class="header-content">
                <a href="/" class="logo" aria-label="–ù–∞ –≥–ª–∞–≤–Ω—É—é LawChecker">
                    <span class="logo-icon">üá∑üá∫</span>
                    <span class="logo-text">LawChecker <span class="logo-badge">Online</span></span>
                </a>
                <nav class="nav">
                    <a href="/" class="nav-link">–ü—Ä–æ–≤–µ—Ä–∫–∞</a>
                    <a href="/api-docs" class="nav-link">API</a>
                    <a href="/admin/metrics" class="nav-link active">Admin Metrics</a>
                </nav>
            </div>
        </div>
    </header>

    <section class="page-hero">
        <div class="container">
            <h1 class="page-hero-title">Admin Metrics</h1>
            <p class="page-hero-subtitle">Read-only –¥–∞—à–±–æ—Ä–¥ –ø–æ —Å–æ–±—ã—Ç–∏—è–º, –æ—à–∏–±–∫–∞–º –∏ –ø–æ—Å–ª–µ–¥–Ω–∏–º –∑–∞–ø—É—Å–∫–∞–º.</p>
            <div class="quick-links">
                <a class="btn btn-secondary" href="/">‚Üê –ù–∞–∑–∞–¥ –∫ –ø—Ä–æ–≤–µ—Ä–∫–µ</a>
                <button class="btn btn-primary" onclick="refreshDashboard()">–û–±–Ω–æ–≤–∏—Ç—å</button>
            </div>
        </div>
    </section>

    <main class="main">
        <div class="container">
            <div class="card">
                <div class="card-header">
                    <h2>–ö–ª—é—á–µ–≤—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏</h2>
                    <p class="text-muted" id="updatedAt">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
                </div>
                <div class="card-body">
                    <div class="stats-grid" id="kpiGrid"></div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h2>–¢–æ–ø endpoint (7 –¥–Ω–µ–π)</h2>
                </div>
                <div class="card-body">
                    <table class="simple-table">
                        <thead>
                            <tr><th>Endpoint</th><th>–ó–∞–ø—Ä–æ—Å–æ–≤</th></tr>
                        </thead>
                        <tbody id="topEndpointsBody"></tbody>
                    </table>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h2>–¢–æ–ø —Å–ª–æ–≤ –Ω–∞—Ä—É—à–µ–Ω–∏–π</h2>
                </div>
                <div class="card-body">
                    <div class="chip-row" id="topWords"></div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h2>–ü–æ—Å–ª–µ–¥–Ω–∏–µ –æ—à–∏–±–∫–∏</h2>
                </div>
                <div class="card-body">
                    <table class="simple-table">
                        <thead>
                            <tr><th>–í—Ä–µ–º—è</th><th>Endpoint</th><th>–ö–æ–¥</th><th>–°–æ–æ–±—â–µ–Ω–∏–µ</th></tr>
                        </thead>
                        <tbody id="errorsBody"></tbody>
                    </table>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h2>–ü–æ—Å–ª–µ–¥–Ω–∏–µ –∑–∞–ø—É—Å–∫–∏</h2>
                </div>
                <div class="card-body">
                    <table class="simple-table">
                        <thead>
                            <tr><th>–í—Ä–µ–º—è</th><th>–¢–∏–ø</th><th>Endpoint</th><th>–°—Ç–∞—Ç—É—Å</th><th>–ù–∞—Ä—É—à–µ–Ω–∏—è</th><th>–í—Ä–µ–º—è, ms</th></tr>
                        </thead>
                        <tbody id="runsBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <script>
        const API_BASE = window.location.origin;

        function fmtDate(v) {
            if (!v) return '-';
            return new Date(v).toLocaleString();
        }

        function row(cells) {
            return `<tr>${cells.map(c => `<td>${c}</td>`).join('')}</tr>`;
        }

        async function refreshDashboard() {
            try {
                const [mResp, hResp] = await Promise.all([
                    fetch(`${API_BASE}/api/metrics`),
                    fetch(`${API_BASE}/api/run-history?limit=20`)
                ]);
                const metrics = await mResp.json();
                const history = await hResp.json();

                if (!mResp.ok || !metrics.enabled) throw new Error(metrics.error || 'Metrics unavailable');

                const w = metrics.window || {};
                document.getElementById('updatedAt').textContent = `–û–±–Ω–æ–≤–ª–µ–Ω–æ: ${fmtDate(metrics.timestamp)}`;
                document.getElementById('kpiGrid').innerHTML = `
                    <div class="stat-item"><span class="stat-number">${w.events_24h ?? 0}</span><span class="stat-label">–°–æ–±—ã—Ç–∏—è 24—á</span></div>
                    <div class="stat-item"><span class="stat-number">${w.events_7d ?? 0}</span><span class="stat-label">–°–æ–±—ã—Ç–∏—è 7–¥</span></div>
                    <div class="stat-item"><span class="stat-number">${w.error_rate_24h ?? 0}%</span><span class="stat-label">–û—à–∏–±–∫–∞ 24—á</span></div>
                    <div class="stat-item"><span class="stat-number">${w.error_rate_7d ?? 0}%</span><span class="stat-label">–û—à–∏–±–∫–∞ 7–¥</span></div>
                    <div class="stat-item"><span class="stat-number">${w.avg_duration_ms_24h ?? 0}</span><span class="stat-label">Avg ms 24—á</span></div>
                    <div class="stat-item"><span class="stat-number">${w.violations_7d ?? 0}</span><span class="stat-label">–ù–∞—Ä—É—à–µ–Ω–∏—è 7–¥</span></div>
                `;

                const topEndpoints = metrics.top_endpoints_7d || [];
                document.getElementById('topEndpointsBody').innerHTML =
                    topEndpoints.length
                        ? topEndpoints.map(i => row([i.endpoint, i.total])).join('')
                        : row(['-', '0']);

                const topWords = metrics.top_violation_words || [];
                document.getElementById('topWords').innerHTML =
                    topWords.length
                        ? topWords.map(i => `<span class="word-tag">${i.word} (${i.count})</span>`).join('')
                        : '<span class="text-muted">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</span>';

                const errors = metrics.recent_errors || [];
                document.getElementById('errorsBody').innerHTML =
                    errors.length
                        ? errors.map(i => row([fmtDate(i.created_at), i.endpoint, i.status_code, i.message_short])).join('')
                        : row(['-', '-', '-', '–ù–µ—Ç –æ—à–∏–±–æ–∫']);

                const runs = (history && history.items) ? history.items : [];
                document.getElementById('runsBody').innerHTML =
                    runs.length
                        ? runs.map(i => row([
                            fmtDate(i.created_at),
                            i.check_type || '-',
                            i.endpoint || '-',
                            i.success ? 'ok' : 'error',
                            i.violations_count ?? 0,
                            i.duration_ms ?? 0
                        ])).join('')
                        : row(['-', '-', '-', '-', '-', '-']);
            } catch (e) {
                document.getElementById('updatedAt').textContent = `–û—à–∏–±–∫–∞: ${e.message}`;
            }
        }

        refreshDashboard();
    </script>
</body>
</html>
