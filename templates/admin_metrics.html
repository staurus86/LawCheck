<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Metrics - LawChecker Online</title>
    <meta name="description" content="–°–µ—Ä–≤–∏—Å–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏ LawChecker: –∑–∞–ø—Ä–æ—Å—ã, –æ—à–∏–±–∫–∏, —Å–∫–æ—Ä–æ—Å—Ç—å, —Ç–æ–ø-—Å–ª–æ–≤–∞ –∏ –∏—Å—Ç–æ—Ä–∏—è –∑–∞–ø—É—Å–∫–æ–≤.">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <header class="header">
        <div class="container">
            <div class="header-content">
                <a href="/" class="logo" aria-label="–ù–∞ –≥–ª–∞–≤–Ω—É—é LawChecker">
                    <span class="logo-icon">üá∑üá∫</span>
                    <span class="logo-text">LawChecker <span class="logo-badge">Online</span></span>
                </a>
                <nav class="nav">
                    <a href="/" class="nav-link">–ü—Ä–æ–≤–µ—Ä–∫–∞</a>
                    <a href="/api-docs" class="nav-link">API</a>
                    <a href="/admin/metrics" class="nav-link active">Admin Metrics</a>
                </nav>
            </div>
        </div>
    </header>

    <section class="page-hero">
        <div class="container">
            <h1 class="page-hero-title">Admin Metrics</h1>
            <p class="page-hero-subtitle">Read-only –¥–∞—à–±–æ—Ä–¥ –ø–æ —Å–æ–±—ã—Ç–∏—è–º, –æ—à–∏–±–∫–∞–º –∏ –ø–æ—Å–ª–µ–¥–Ω–∏–º –∑–∞–ø—É—Å–∫–∞–º.</p>
            <div class="quick-links">
                <a class="btn btn-secondary" href="/">‚Üê –ù–∞–∑–∞–¥ –∫ –ø—Ä–æ–≤–µ—Ä–∫–µ</a>
                <button class="btn btn-primary" onclick="refreshDashboard()">–û–±–Ω–æ–≤–∏—Ç—å</button>
                <button class="btn btn-danger" onclick="cleanupMetrics()" style="margin-left: 10px;">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –ë–î</button>
            </div>
        </div>
    </section>

    <main class="main">
        <div class="container">
            <div class="card">
                <div class="card-header">
                    <h2>–§–∏–ª—å—Ç—Ä—ã</h2>
                </div>
                <div class="card-body">
                    <div class="admin-filters">
                        <div>
                            <label class="text-muted" for="fDays">–ü–µ—Ä–∏–æ–¥</label>
                            <select id="fDays" class="form-input">
                                <option value="1">1 –¥–µ–Ω—å</option>
                                <option value="7" selected>7 –¥–Ω–µ–π</option>
                                <option value="30">30 –¥–Ω–µ–π</option>
                                <option value="90">90 –¥–Ω–µ–π</option>
                            </select>
                        </div>
                        <div>
                            <label class="text-muted" for="fType">–¢–∏–ø –ø—Ä–æ–≤–µ—Ä–∫–∏</label>
                            <select id="fType" class="form-input">
                                <option value="all">–í—Å–µ</option>
                                <option value="text">text</option>
                                <option value="url">url</option>
                                <option value="batch">batch</option>
                                <option value="image">image</option>
                                <option value="multiscan">multiscan</option>
                            </select>
                        </div>
                        <div>
                            <label class="text-muted" for="fStatus">–°—Ç–∞—Ç—É—Å</label>
                            <select id="fStatus" class="form-input">
                                <option value="all">–í—Å–µ</option>
                                <option value="ok">ok</option>
                                <option value="error">error</option>
                            </select>
                        </div>
                    </div>
                    <div class="btn-group">
                        <button class="btn btn-primary" onclick="refreshDashboard()">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
                        <button class="btn btn-secondary" onclick="resetFilters()">–°–±—Ä–æ—Å–∏—Ç—å</button>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h2>–ö–ª—é—á–µ–≤—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏</h2>
                    <p class="text-muted" id="updatedAt">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
                </div>
                <div class="card-body">
                    <div class="stats-grid" id="kpiGrid"></div>
                    <div class="trend-block">
                        <h3>–¢—Ä–µ–Ω–¥ –ø–æ –¥–Ω—è–º</h3>
                        <div id="trendBars" class="trend-bars"></div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h2>–¢–æ–ø endpoint (7 –¥–Ω–µ–π)</h2>
                </div>
                <div class="card-body">
                    <table class="simple-table">
                        <thead>
                            <tr><th>Endpoint</th><th>–ó–∞–ø—Ä–æ—Å–æ–≤</th></tr>
                        </thead>
                        <tbody id="topEndpointsBody"></tbody>
                    </table>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h2>–¢–æ–ø —Å–ª–æ–≤ –Ω–∞—Ä—É—à–µ–Ω–∏–π</h2>
                </div>
                <div class="card-body">
                    <div class="chip-row" id="topWords"></div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h2>–ü–æ—Å–ª–µ–¥–Ω–∏–µ –æ—à–∏–±–∫–∏</h2>
                </div>
                <div class="card-body">
                    <table class="simple-table">
                        <thead>
                            <tr><th>–í—Ä–µ–º—è</th><th>Endpoint</th><th>–ö–æ–¥</th><th>–°–æ–æ–±—â–µ–Ω–∏–µ</th></tr>
                        </thead>
                        <tbody id="errorsBody"></tbody>
                    </table>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h2>–ü–æ—Å–ª–µ–¥–Ω–∏–µ –∑–∞–ø—É—Å–∫–∏</h2>
                </div>
                <div class="card-body">
                    <table class="simple-table">
                        <thead>
                            <tr><th>–í—Ä–µ–º—è</th><th>–¢–∏–ø</th><th>Endpoint</th><th>–°—Ç–∞—Ç—É—Å</th><th>–ù–∞—Ä—É—à–µ–Ω–∏—è</th><th>–í—Ä–µ–º—è, ms</th></tr>
                        </thead>
                        <tbody id="runsBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <script>
        const API_BASE = window.location.origin;

        function fmtDate(v) {
            if (!v) return '-';
            return new Date(v).toLocaleString();
        }

        function row(cells) {
            return `<tr>${cells.map(c => `<td>${c}</td>`).join('')}</tr>`;
        }

        function getFilters() {
            const days = document.getElementById('fDays').value || '7';
            const checkType = document.getElementById('fType').value || 'all';
            const status = document.getElementById('fStatus').value || 'all';
            return { days, checkType, status };
        }

        function resetFilters() {
            document.getElementById('fDays').value = '7';
            document.getElementById('fType').value = 'all';
            document.getElementById('fStatus').value = 'all';
            refreshDashboard();
        }

        function renderTrend(rows) {
            const container = document.getElementById('trendBars');
            if (!container) return;
            if (!rows || !rows.length) {
                container.innerHTML = '<div class="text-muted">–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ç—Ä–µ–Ω–¥–∞.</div>';
                return;
            }
            const max = Math.max(...rows.map(r => r.total || 0), 1);
            container.innerHTML = rows.map(r => {
                const total = r.total || 0;
                const errors = r.errors || 0;
                const w = Math.max(6, Math.round((total / max) * 100));
                const ew = total ? Math.round((errors / total) * 100) : 0;
                return `
                    <div class="trend-row">
                        <span class="trend-day">${r.day}</span>
                        <div class="trend-bar-wrap">
                            <div class="trend-bar" style="width:${w}%">
                                <span class="trend-bar-errors" style="width:${ew}%"></span>
                            </div>
                        </div>
                        <span class="trend-val">${total}</span>
                    </div>
                `;
            }).join('');
        }

        async function refreshDashboard() {
            try {
                const f = getFilters();
                const qMetrics = new URLSearchParams({ days: f.days }).toString();
                const qHistory = new URLSearchParams({
                    limit: '20',
                    days: f.days,
                    check_type: f.checkType,
                    status: f.status
                }).toString();
                const [mResp, hResp] = await Promise.all([
                    fetch(`${API_BASE}/api/metrics?${qMetrics}`),
                    fetch(`${API_BASE}/api/run-history?${qHistory}`)
                ]);
                const metrics = await mResp.json();
                const history = await hResp.json();

                if (!mResp.ok || !metrics.enabled) throw new Error(metrics.error || 'Metrics unavailable');

                const w = metrics.window || {};
                document.getElementById('updatedAt').textContent = `–û–±–Ω–æ–≤–ª–µ–Ω–æ: ${fmtDate(metrics.timestamp)}`;
                document.getElementById('kpiGrid').innerHTML = `
                    <div class="stat-item"><span class="stat-number">${w.events_total ?? 0}</span><span class="stat-label">–°–æ–±—ã—Ç–∏—è (${w.days ?? f.days}–¥)</span></div>
                    <div class="stat-item"><span class="stat-number">${w.errors_total ?? 0}</span><span class="stat-label">–û—à–∏–±–∫–∏</span></div>
                    <div class="stat-item"><span class="stat-number">${w.error_rate ?? 0}%</span><span class="stat-label">Error rate</span></div>
                    <div class="stat-item"><span class="stat-number">${w.avg_duration_ms ?? 0}</span><span class="stat-label">Avg ms</span></div>
                    <div class="stat-item"><span class="stat-number">${w.violations_total ?? 0}</span><span class="stat-label">–ù–∞—Ä—É—à–µ–Ω–∏—è</span></div>
                `;
                renderTrend(metrics.trend_by_day || []);

                const topEndpoints = metrics.top_endpoints_7d || [];
                document.getElementById('topEndpointsBody').innerHTML =
                    topEndpoints.length
                        ? topEndpoints.map(i => row([i.endpoint, i.total])).join('')
                        : row(['-', '0']);

                const topWords = metrics.top_violation_words || [];
                document.getElementById('topWords').innerHTML =
                    topWords.length
                        ? topWords.map(i => `<span class="word-tag">${i.word} (${i.count})</span>`).join('')
                        : '<span class="text-muted">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</span>';

                const errors = metrics.recent_errors || [];
                document.getElementById('errorsBody').innerHTML =
                    errors.length
                        ? errors.map(i => row([fmtDate(i.created_at), i.endpoint, i.status_code, i.message_short])).join('')
                        : row(['-', '-', '-', '–ù–µ—Ç –æ—à–∏–±–æ–∫']);

                const runs = (history && history.items) ? history.items : [];
                document.getElementById('runsBody').innerHTML =
                    runs.length
                        ? runs.map(i => row([
                            fmtDate(i.created_at),
                            i.check_type || '-',
                            i.endpoint || '-',
                            i.success ? 'ok' : 'error',
                            i.violations_count ?? 0,
                            i.duration_ms ?? 0
                        ])).join('')
                        : row(['-', '-', '-', '-', '-', '-']);
            } catch (e) {
                document.getElementById('updatedAt').textContent = `–û—à–∏–±–∫–∞: ${e.message}`;
            }
        }

        async function cleanupMetrics() {
            if (!confirm('‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï!\n\n–≠—Ç–∞ –æ–ø–µ—Ä–∞—Ü–∏—è –ü–û–õ–ù–û–°–¢–¨–Æ —É–¥–∞–ª–∏—Ç –í–°–ï –º–µ—Ç—Ä–∏–∫–∏ –∏–∑ –ë–î:\n- –°–æ–±—ã—Ç–∏—è\n- –û—à–∏–±–∫–∏\n- –ò—Å—Ç–æ—Ä–∏—è –ø—Ä–æ–≤–µ—Ä–æ–∫\n- –°–ª–æ–≤–∞-–Ω–∞—Ä—É—à–µ–Ω–∏—è\n\n–≠—Ç–æ –æ—Å–≤–æ–±–æ–¥–∏—Ç –º–µ—Å—Ç–æ –≤ PostgreSQL.\n\n–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?')) {
                return;
            }

            const secret = prompt('–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è:\n\n' +
                                  '–ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:\n' +
                                  '1. "CLEANUP_DB" (–ø—Ä–æ—Å—Ç–æ–π –ø–∞—Ä–æ–ª—å)\n' +
                                  '2. –ü–µ—Ä–≤—ã–µ 16 —Å–∏–º–≤–æ–ª–æ–≤ –≤–∞—à–µ–≥–æ SECRET_KEY');
            if (!secret) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/api/metrics/cleanup`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ secret })
                });

                const result = await response.json();

                if (!response.ok) {
                    alert(`–û—à–∏–±–∫–∞: ${result.error || '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—á–∏—Å—Ç–∏—Ç—å –º–µ—Ç—Ä–∏–∫–∏'}`);
                    return;
                }

                if (result.success) {
                    alert(`‚úÖ –ú–µ—Ç—Ä–∏–∫–∏ —É—Å–ø–µ—à–Ω–æ –æ—á–∏—â–µ–Ω—ã!\n\n` +
                          `–£–¥–∞–ª–µ–Ω–æ:\n` +
                          `- –°–æ–±—ã—Ç–∏—è: ${result.events_deleted || 0}\n` +
                          `- –û—à–∏–±–∫–∏: ${result.errors_deleted || 0}\n` +
                          `- –ò—Å—Ç–æ—Ä–∏—è: ${result.history_deleted || 0}\n` +
                          `- –°–ª–æ–≤–∞: ${result.words_deleted || 0}\n\n` +
                          `VACUUM –≤—ã–ø–æ–ª–Ω–µ–Ω –¥–ª—è –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏—è –º–µ—Å—Ç–∞.`);
                    refreshDashboard();
                } else {
                    alert(`–û—à–∏–±–∫–∞: ${result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}`);
                }
            } catch (error) {
                alert(`–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ${error.message}`);
            }
        }

        refreshDashboard();
    </script>
</body>
</html>
